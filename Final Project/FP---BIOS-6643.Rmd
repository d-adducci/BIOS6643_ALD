---
title: "Final Project - BIOS 6643"
author: "Dominic Adducci"
date: "2023-12-09"
output:
  pdf_document: default
header-includes:
- \usepackage{setspace}\doublespacing
- \usepackage{etoolbox}
- \AtBeginEnvironment{Shaded}{\singlespace}
bibliography: bio_final_project_citations.bib
csl: alex_vancouver.csl
---

```{r setup, echo = F, message = F, warning = F}

library(tidyverse)
library(kableExtra)
library(mgcv)
library(patchwork)
library(plyr)
library(knitr)

```

```{r data, echo = F}

# Loading in the data from previously run gam models. 

load("C:/Users/domin/Documents/Biostatistics Masters Program/Fall 2023/BIOS 6643 - ADL/BIOS6643_ALD/Final Project/ProcessedData/saved_gam_models.RData")

# Loading in the project2 data.
project2_data <- readRDS("C:/Users/domin/Documents/Biostatistics Masters Program/Fall 2023/BIOS 6643 - ADL/BIOS6643_ALD/Final Project/ProcessedData/project2_data.rds")

```

```{r, message = F, eval = F}

# This code was run in another file previously. Included to illustrate what was done.

# Loading in the variogram data. 
variogram_raw <- read_csv("C:/Users/domin/Documents/Biostatistics Masters Program/Fall 2023/BIOS 6643 - ADL/BIOS6643_ALD/Final Project/RawData/6643Project_VariogramDataV2.csv")

# Selecting out data for project 2, factoring lungs, and removing the project
# specific variables. 
variogram_data <- variogram_raw %>% subset(P2 == 1) %>%
  mutate(lung = factor(lung,labels = c("Left","Right"))) %>% 
  select(-P1,-P2,-P3) %>%
  subset(ID != "03S080" & ID != "01S042") 

# Loading in the clinical data. 
clinical_data_raw <- read_csv("C:/Users/domin/Documents/Biostatistics Masters Program/Fall 2023/BIOS 6643 - ADL/BIOS6643_ALD/Final Project/RawData/6643Project_ClinicalDataV2.csv")

# Determining number of subjects who are in both data frames:
variogram_number <- length(unique(variogram_data$ID)) 
clinical_number <- length(unique(clinical_data_raw$ID))

# Formatting the clinical data. Will factor variables and will select out subjects
# who are in both df. 
clinical_data <- clinical_data_raw %>%
  filter(ID %in% variogram_data$ID) %>%
  mutate(Ground_Glass = factor(Ground_Glass),
         Traction_Bronchiectasis = factor(Traction_Bronchiectasis),
         Fibrosis = factor(Fibrosis, labels = c("No","Yes")),
         Interlobular_Septal_Thick = factor(Interlobular_Septal_Thick),
         Mosaic_Attenuation = factor(Mosaic_Attenuation),
         Med_Lymphadenopathy = factor(Med_Lymphadenopathy),
         Gender = factor(Gender, levels = c("Female","Male"))) %>%
  mutate(Traction_Bronchiectasis = fct_collapse(Traction_Bronchiectasis,
                                                No = 0,
                                                Yes = c(1,2,3)),
         Med_Lymphadenopathy = fct_collapse(Med_Lymphadenopathy,
                                            No = 0,
                                            Yes = c(2,3))) %>%
  subset(ID != "03S080" & ID != "01S042")

# Combining two data frames together by ID. Dropping observations which are missing specified
# values and demographic data. 
project2_data <- merge(variogram_data,clinical_data,
                       by = "ID", sort = FALSE) %>% arrange(ID,lung) %>%
  drop_na(Race, Ethnicity)

# Factoring the race
project2_data_factor <- project2_data %>%
  mutate(Race = factor(Race))

# Collapsing race category
project2_data_new <- project2_data_factor %>%
  mutate(Race = fct_collapse(Race,
                             white = "White Non-Hispanic",
                             black_or_african_american = "Black or African American",
                             other = c("American Indian or Alaska Native",
                                       "Asian","Multi-racial or No Primary Race",
                                       "Unknown","White Hispanic"))) %>%
  mutate(Race = recode(Race, White = "White",
                       black_or_african_american = "Black or African American",
                       other = "Other")) %>%
  mutate(Race = relevel(Race, ref = "Black or African American"))

project2_data_raw <- readRDS("C:/Users/domin/Documents/Biostatistics Masters Program/Fall 2023/BIOS 6643 - ADL/BIOS6643_ALD/Final Project/ProcessedData/project2_data.rds")

# Turning the ID column in to a factor, and logging psill and range. 
project2_data <- project2_data_raw %>% 
  mutate(ID = factor(ID),
         log_psill = log(psill),
         log_range = log(range)) %>%
  mutate(Fibrosis = recode(Fibrosis,
                           No = 0, Yes = 1),
         Traction_Bronchiectasis = recode(Traction_Bronchiectasis,
                                          No = 0,Yes = 1),
         Med_Lymphadenopathy = recode(Med_Lymphadenopathy,
                                      No = 0, Yes = 1)) %>% 
  select(ID,lung,psill,range,slice_normalized,BMI,Age,Gender,Height,
         Race,Traction_Bronchiectasis,Fibrosis,Med_Lymphadenopathy,
         POSTFEV1,POSTFVC,POSTFEVFVC,log_psill,log_range)

left_lung_data <- project2_data %>% filter(lung == "Left")
right_lung_data <- project2_data %>% filter(lung == "Right")

# Left Lung log(Psill) models including race. 

# Model where Fibrosis is the primary predictor.
lp_fib_race_mod <- gam(log_psill ~ s(slice_normalized,bs = "ps",m = c(2,2)) +
                         BMI + Age + Gender + Height + Race + s(ID,bs = "re") + 
                         s(slice_normalized,by = Fibrosis,bs = "ps"),
                       data = left_lung_data, family = gaussian, method = "ML")

lp_fib_race_mod_sum <- tidy(lp_fib_race_mod, parametric = T) %>%
  select(term, estimate, std.error, p.value) %>%
  mutate(p.value = format.pval(p.value, digits = 3))

# Model where Mediastinal Lymphadenopathy is the primary predictor.
lp_med_race_mod <- gam(log_psill ~ s(slice_normalized,bs = "ps",m = c(2,2)) +
                         BMI + Age + Gender + Height + Race + s(ID,bs = "re") + 
                         s(slice_normalized,by = Med_Lymphadenopathy,bs = "ps"), 
                       data = left_lung_data, family = gaussian, method = "ML")

lp_med_race_mod_sum <- tidy(lp_med_race_mod, parametric = T) %>%
  select(term, estimate, std.error, p.value) %>%
  mutate(p.value = format.pval(p.value, digits = 3))

# Model where Traction Bronchiectasis is the primary predictor. 
lp_tra_race_mod <- gam(log_psill ~ s(slice_normalized,bs = "ps",m = c(2,2)) +
                         BMI + Age + Gender + Height + Race + s(ID,bs = "re") + 
                         s(slice_normalized,by = Traction_Bronchiectasis,bs = "ps"),
                       data = left_lung_data, family = gaussian, method = "ML")

lp_tra_race_mod_sum <- tidy(lp_tra_race_mod, parametric = T) %>%
  select(term, estimate, std.error, p.value) %>%
  mutate(p.value = format.pval(p.value, digits = 3))

# Model where FEV1 is the primary predictor. 
lp_fev1_race_mod <- gam(log_psill ~ s(slice_normalized,bs = "ps",m = c(2,2)) + 
                          BMI + Age + Gender + Height + Race + s(ID,bs = "re") + 
                          s(slice_normalized,by = POSTFEV1,bs = "ps"), 
                        data = left_lung_data, family = gaussian, method = "ML")

lp_fev1_race_mod_sum <- tidy(lp_fev1_race_mod, parametric = T) %>%
  select(term, estimate, std.error, p.value) %>%
  mutate(p.value = format.pval(p.value, digits = 3))

# Model where FVC is the primary predictor. 
lp_fvc_race_mod <- gam(log_psill ~ s(slice_normalized,bs = "ps",m = c(2,2)) +
                         BMI + Age + Gender + Height + Race + s(ID,bs = "re") + 
                         s(slice_normalized,by = POSTFVC,bs = "ps"),
                       data = left_lung_data, family = gaussian, method = "ML") 

lp_fvc_race_mod_sum <- tidy(lp_fvc_race_mod, parametric = T) %>%
  select(term, estimate, std.error, p.value) %>%
  mutate(p.value = format.pval(p.value, digits = 3))

# Model where FEV1/FVC is the primary predictor. 
lp_fev1_fvc_race_mod <- gam(log_psill ~ s(slice_normalized,bs = "ps",m = c(2,2)) +
                              BMI + Age + Gender + Height + Race + s(ID,bs = "re") + 
                              s(slice_normalized,by = POSTFEVFVC,bs = "ps"), 
                            data = left_lung_data, family = gaussian, method = "ML") 

lp_fev1_fvc_race_mod_sum <- tidy(lp_fev1_fvc_race_mod, parametric = T) %>%
  select(term, estimate, std.error, p.value) %>%
  mutate(p.value = format.pval(p.value, digits = 3))

# Left lung log(psill) models not including race. 

# Model where Fibrosis is the primary predictor.
lp_fib_mod <- gam(log_psill ~ s(slice_normalized,bs = "ps",m = c(2,2)) +
                    BMI + Age + Gender + Height + s(ID,bs = "re") +
                    s(slice_normalized,by = Fibrosis,bs = "ps"),
                  data = left_lung_data, family = gaussian, method = "ML")

lp_fib_mod_sum <- tidy(lp_fib_mod, parametric = T) %>%
  select(term, estimate, std.error, p.value) %>%
  mutate(p.value = format.pval(p.value, digits = 3))

# Model where Mediastinal Lymphadenopathy is the primary predictor.
lp_med_mod <- gam(log_psill ~ s(slice_normalized,bs = "ps",m = c(2,2)) +
                    BMI + Age + Gender + Height + s(ID,bs = "re") + 
                    s(slice_normalized,by = Med_Lymphadenopathy,bs = "ps"), 
                  data = left_lung_data, family = gaussian, method = "ML")

lp_med_mod_sum <- tidy(lp_med_mod, parametric = T) %>%
  select(term, estimate, std.error, p.value) %>%
  mutate(p.value = format.pval(p.value, digits = 3))

# Model where Traction Bronchiectasis is the primary predictor. 
lp_tra_mod <- gam(log_psill ~ s(slice_normalized,bs = "ps",m = c(2,2)) +
                    BMI + Age + Gender + Height + s(ID,bs = "re") + 
                    s(slice_normalized,by = Traction_Bronchiectasis,bs = "ps"),
                  data = left_lung_data, family = gaussian, method = "ML")

lp_tra_mod_sum <- tidy(lp_tra_mod, parametric = T) %>%
  select(term, estimate, std.error, p.value) %>%
  mutate(p.value = format.pval(p.value, digits = 3))

# Model where FEV1 is the primary predictor. 
lp_fev1_mod <- gam(log_psill ~ s(slice_normalized,bs = "ps",m = c(2,2)) + 
                     BMI + Age + Gender + Height + s(ID,bs = "re") +
                     s(slice_normalized,by = POSTFEV1,bs = "ps"),
                   data = left_lung_data, family = gaussian, method = "ML")

lp_fev1_mod_sum <- tidy(lp_fev1_mod, parametric = T) %>%
  select(term, estimate, std.error, p.value) %>%
  mutate(p.value = format.pval(p.value, digits = 3))

# Model where FVC is the primary predictor. 
lp_fvc_mod <- gam(log_psill ~ s(slice_normalized,bs = "ps",m = c(2,2)) +
                    BMI + Age + Gender + Height + s(ID,bs = "re") +
                    s(slice_normalized,by = POSTFVC,bs = "bs"),
                  data = left_lung_data, family = gaussian, method = "ML") 

lp_fvc_mod_sum <- tidy(lp_fvc_mod, parametric = T) %>%
  select(term, estimate, std.error, p.value) %>%
  mutate(p.value = format.pval(p.value, digits = 3))

# Model where FEV1/FVC is the primary predictor. 
lp_fev1_fvc_mod <- gam(log_psill ~ s(slice_normalized,bs = "ps",m = c(2,2)) +
                         BMI + Age + Gender + Height + s(ID,bs = "re") + 
                         s(slice_normalized,by = POSTFEVFVC,bs = "ps"), 
                       data = left_lung_data, family = gaussian, method = "ML") 

lp_fev1_fvc_mod_sum <- tidy(lp_fev1_fvc_mod, parametric = T) %>%
  select(term, estimate, std.error, p.value) %>%
  mutate(p.value = format.pval(p.value, digits = 3))

# Left Lung log(Range) models including race. 

# Model where Fibrosis is the primary predictor.
lr_fib_race_mod <- gam(log_range ~ s(slice_normalized,bs = "ps",m = c(2,2)) +
                         BMI + Age + Gender + Height + Race + s(ID,bs = "re") + 
                         s(slice_normalized,by = Fibrosis,bs = "ps"),
                       data = left_lung_data, family = gaussian, method = "ML")

lr_fib_race_mod_sum <- tidy(lr_fib_race_mod, parametric = T) %>%
  select(term, estimate, std.error, p.value) %>%
  mutate(p.value = format.pval(p.value, digits = 3))

# Model where Mediastinal Lymphadenopathy is the primary predictor.
lr_med_race_mod <- gam(log_range ~ s(slice_normalized,bs = "ps",m = c(2,2)) +
                         BMI + Age + Gender + Height + Race + s(ID,bs = "re") + 
                         s(slice_normalized,by = Med_Lymphadenopathy,bs = "ps"), 
                       data = left_lung_data, family = gaussian, method = "ML")

lr_med_race_mod_sum <- tidy(lr_med_race_mod, parametric = T) %>%
  select(term, estimate, std.error, p.value) %>%
  mutate(p.value = format.pval(p.value, digits = 3))

# Model where Traction Bronchiectasis is the primary predictor. 
lr_tra_race_mod <- gam(log_range ~ s(slice_normalized,bs = "ps",m = c(2,2)) +
                         BMI + Age + Gender + Height + Race + s(ID,bs = "re") + 
                         s(slice_normalized,by = Traction_Bronchiectasis,bs = "ps"), 
                       data = left_lung_data, family = gaussian, method = "ML")

lr_tra_race_mod_sum <- tidy(lr_tra_race_mod, parametric = T) %>%
  select(term, estimate, std.error, p.value) %>%
  mutate(p.value = format.pval(p.value, digits = 3))

# Model where FEV1 is the primary predictor. 
lr_fev1_race_mod <- gam(log_range ~ s(slice_normalized,bs = "ps",m = c(2,2)) + 
                          BMI + Age + Gender + Height + Race + s(ID,bs = "re") + 
                          s(slice_normalized,by = POSTFEV1,bs = "ps"), 
                        data = left_lung_data, family = gaussian, method = "ML")

lr_fev1_race_mod_sum <- tidy(lr_fev1_race_mod, parametric = T) %>%
  select(term, estimate, std.error, p.value) %>%
  mutate(p.value = format.pval(p.value, digits = 3))

# Model where FVC is the primary predictor. 
lr_fvc_race_mod <- gam(log_range ~ s(slice_normalized,bs = "ps",m = c(2,2)) +
                         BMI + Age + Gender + Height + Race + s(ID,bs = "re") + 
                         s(slice_normalized,by = POSTFVC,bs = "ps"), 
                       data = left_lung_data, family = gaussian, method = "ML") 

lr_fvc_race_mod_sum <- tidy(lr_fvc_race_mod, parametric = T) %>%
  select(term, estimate, std.error, p.value) %>%
  mutate(p.value = format.pval(p.value, digits = 3))

# Model where FEV1/FVC is the primary predictor. 
lr_fev1_fvc_race_mod <- gam(log_range ~ s(slice_normalized,bs = "ps",m = c(2,2)) +
                              BMI + Age + Gender + Height + Race + s(ID,bs = "re") + 
                              s(slice_normalized,by = POSTFEVFVC,bs = "ps"), 
                            data = left_lung_data, family = gaussian, method = "ML") 

lr_fev1_fvc_race_mod_sum <- tidy(lr_fev1_fvc_race_mod, parametric = T) %>%
  select(term, estimate, std.error, p.value) %>%
  mutate(p.value = format.pval(p.value, digits = 3))

# Left lung log(Range) models not including race. 

# Model where Fibrosis is the primary predictor.
lr_fib_mod <- gam(log_range ~ s(slice_normalized,bs = "ps",m = c(2,2)) +
                    BMI + Age + Gender + Height + s(ID,bs = "re") + 
                    s(slice_normalized,by = Fibrosis,bs = "ps"), 
                  data = left_lung_data, family = gaussian, method = "ML")

lr_fib_mod_sum <- tidy(lr_fib_mod, parametric = T) %>%
  select(term, estimate, std.error, p.value) %>%
  mutate(p.value = format.pval(p.value, digits = 3))

# Model where Mediastinal Lymphadenopathy is the primary predictor.
lr_med_mod <- gam(log_range ~ s(slice_normalized,bs = "ps",m = c(2,2)) +
                    BMI + Age + Gender + Height + s(ID,bs = "re") + 
                    s(slice_normalized,by = Med_Lymphadenopathy,bs = "ps"), 
                  data = left_lung_data, family = gaussian, method = "ML")

lr_med_mod_sum <- tidy(lr_med_mod, parametric = T) %>%
  select(term, estimate, std.error, p.value) %>%
  mutate(p.value = format.pval(p.value, digits = 3))

# Model where Traction Bronchiectasis is the primary predictor. 
lr_tra_mod <- gam(log_range ~ s(slice_normalized,bs = "ps",m = c(2,2)) +
                    BMI + Age + Gender + Height + s(ID,bs = "re") + 
                    s(slice_normalized,by = Traction_Bronchiectasis,bs = "ps"), 
                  data = left_lung_data, family = gaussian, method = "ML")

lr_tra_mod_sum <- tidy(lr_tra_mod, parametric = T) %>%
  select(term, estimate, std.error, p.value) %>%
  mutate(p.value = format.pval(p.value, digits = 3))

# Model where FEV1 is the primary predictor. 
lr_fev1_mod <- gam(log_range ~ s(slice_normalized,bs = "ps",m = c(2,2)) + 
                     BMI + Age + Gender + Height + s(ID,bs = "re") +
                     s(slice_normalized,by = POSTFEV1,bs = "ps"),
                   data = left_lung_data, family = gaussian, method = "ML")

lr_fev1_mod_sum <- tidy(lr_fev1_mod, parametric = T) %>%
  select(term, estimate, std.error, p.value) %>%
  mutate(p.value = format.pval(p.value, digits = 3))

# Model where FVC is the primary predictor. 
lr_fvc_mod <- gam(log_range ~ s(slice_normalized,bs = "ps",m = c(2,2)) +
                    BMI + Age + Gender + Height + s(ID,bs = "re") +
                    s(slice_normalized,by = POSTFVC,bs = "ps"),
                  data = left_lung_data, family = gaussian, method = "ML") 

lr_fvc_mod_sum <- tidy(lr_fvc_mod, parametric = T) %>%
  select(term, estimate, std.error, p.value) %>%
  mutate(p.value = format.pval(p.value, digits = 3))

# Model where FEV1/FVC is the primary predictor. 
lr_fev1_fvc_mod <- gam(log_range ~ s(slice_normalized,bs = "ps",m = c(2,2)) +
                         BMI + Age + Gender + Height + s(ID,bs = "re") + 
                         s(slice_normalized,by = POSTFEVFVC,bs = "ps"), 
                       data = left_lung_data, family = gaussian, method = "ML") 

lr_fev1_fvc_mod_sum <- tidy(lr_fev1_fvc_mod, parametric = T) %>%
  select(term, estimate, std.error, p.value) %>%
  mutate(p.value = format.pval(p.value, digits = 3))

# Right Lung log(Psill) models including race. 

# Model where Fibrosis is the primary predictor.
rp_fib_race_mod <- gam(log_psill ~ s(slice_normalized,bs = "ps",m = c(2,2)) +
                         BMI + Age + Gender + Height + Race + s(ID,bs = "re") + 
                         s(slice_normalized,by = Fibrosis,bs = "ps"), 
                       data = right_lung_data, family = gaussian, method = "ML")

rp_fib_race_mod_sum <- tidy(rp_fib_race_mod, parametric = T) %>%
  select(term, estimate, std.error, p.value) %>%
  mutate(p.value = format.pval(p.value, digits = 3))

# Model where Mediastinal Lymphadenopathy is the primary predictor.
rp_med_race_mod <- gam(log_psill ~ s(slice_normalized,bs = "ps",m = c(2,2)) +
                         BMI + Age + Gender + Height + Race + s(ID,bs = "re") + 
                         s(slice_normalized,by = Med_Lymphadenopathy,bs = "ps"), 
                       data = right_lung_data, family = gaussian, method = "ML")

rp_med_race_mod_sum <- tidy(rp_med_race_mod, parametric = T) %>%
  select(term, estimate, std.error, p.value) %>%
  mutate(p.value = format.pval(p.value, digits = 3))

# Model where Traction Bronchiectasis is the primary predictor. 
rp_tra_race_mod <- gam(log_psill ~ s(slice_normalized,bs = "ps",m = c(2,2)) +
                         BMI + Age + Gender + Height + Race + s(ID,bs = "re") + 
                         s(slice_normalized,by = Traction_Bronchiectasis,bs = "ps"), 
                       data = right_lung_data, family = gaussian, method = "ML")

rp_tra_race_mod_sum <- tidy(rp_tra_race_mod, parametric = T) %>%
  select(term, estimate, std.error, p.value) %>%
  mutate(p.value = format.pval(p.value, digits = 3))

# Model where FEV1 is the primary predictor. 
rp_fev1_race_mod <- gam(log_psill ~ s(slice_normalized,bs = "ps",m = c(2,2)) + 
                          BMI + Age + Gender + Height + Race + s(ID,bs = "re") + 
                          s(slice_normalized,by = POSTFEV1,bs = "ps"), 
                        data = right_lung_data, family = gaussian, method = "ML")

rp_fev1_race_mod_sum <- tidy(rp_fev1_race_mod, parametric = T) %>%
  select(term, estimate, std.error, p.value) %>%
  mutate(p.value = format.pval(p.value, digits = 3))

# Model where FVC is the primary predictor. 
rp_fvc_race_mod <- gam(log_psill ~ s(slice_normalized,bs = "ps",m = c(2,2)) +
                         BMI + Age + Gender + Height + Race + s(ID,bs = "re") + 
                         s(slice_normalized,by = POSTFVC,bs = "ps"), 
                       data = right_lung_data, family = gaussian, method = "ML") 

rp_fvc_race_mod_sum <- tidy(rp_fvc_race_mod, parametric = T) %>%
  select(term, estimate, std.error, p.value) %>%
  mutate(p.value = format.pval(p.value, digits = 3))

# Model where FEV1/FVC is the primary predictor. 
rp_fev1_fvc_race_mod <- gam(log_psill ~ s(slice_normalized,bs = "ps",m = c(2,2)) +
                              BMI + Age + Gender + Height + Race + s(ID,bs = "re") + 
                              s(slice_normalized,by = POSTFEVFVC,bs = "ps"), 
                            data = right_lung_data, family = gaussian, method = "ML") 

rp_fev1_fvc_race_mod_sum <- tidy(rp_fev1_fvc_race_mod, parametric = T) %>%
  select(term, estimate, std.error, p.value) %>%
  mutate(p.value = format.pval(p.value, digits = 3))

# Right lung log(psill) models not including race. 

# Model where Fibrosis is the primary predictor.
rp_fib_mod <- gam(log_psill ~ s(slice_normalized,bs = "ps",m = c(2,2)) +
                    BMI + Age + Gender + Height + s(ID,bs = "re") +
                    s(slice_normalized,by = Fibrosis,bs = "ps"),
                  data = right_lung_data, family = gaussian, method = "ML")

rp_fib_mod_sum <- tidy(rp_fib_mod, parametric = T) %>%
  select(term, estimate, std.error, p.value) %>%
  mutate(p.value = format.pval(p.value, digits = 3))

# Model where Mediastinal Lymphadenopathy is the primary predictor.
rp_med_mod <- gam(log_psill ~ s(slice_normalized,bs = "ps",m = c(2,2)) +
                    BMI + Age + Gender + Height + s(ID,bs = "re") + 
                    s(slice_normalized,by = Med_Lymphadenopathy,bs = "ps"), 
                  data = right_lung_data, family = gaussian, method = "ML")

rp_med_mod_sum <- tidy(rp_med_mod, parametric = T) %>%
  select(term, estimate, std.error, p.value) %>%
  mutate(p.value = format.pval(p.value, digits = 3))

# Model where Traction Bronchiectasis is the primary predictor. 
rp_tra_mod <- gam(log_psill ~ s(slice_normalized,bs = "ps",m = c(2,2)) +
                    BMI + Age + Gender + Height + s(ID,bs = "re") + 
                    s(slice_normalized,by = Traction_Bronchiectasis,bs = "ps"), 
                  data = right_lung_data, family = gaussian, method = "ML")

rp_tra_mod_sum <- tidy(rp_tra_mod, parametric = T) %>%
  select(term, estimate, std.error, p.value) %>%
  mutate(p.value = format.pval(p.value, digits = 3))

# Model where FEV1 is the primary predictor. 
rp_fev1_mod <- gam(log_psill ~ s(slice_normalized,bs = "ps",m = c(2,2)) + 
                     BMI + Age + Gender + Height + s(ID,bs = "re") +
                     s(slice_normalized,by = POSTFEV1,bs = "ps"),
                   data = right_lung_data, family = gaussian, method = "ML")

rp_fev1_mod_sum <- tidy(rp_fev1_mod, parametric = T) %>%
  select(term, estimate, std.error, p.value) %>%
  mutate(p.value = format.pval(p.value, digits = 3))

# Model where FVC is the primary predictor. 
rp_fvc_mod <- gam(log_psill ~ s(slice_normalized,bs = "ps",m = c(2,2)) +
                    BMI + Age + Gender + Height + s(ID,bs = "re") +
                    s(slice_normalized,by = POSTFVC,bs = "ps"),
                  data = right_lung_data, family = gaussian, method = "ML") 

rp_fvc_mod_sum <- tidy(rp_fvc_mod, parametric = T) %>%
  select(term, estimate, std.error, p.value) %>%
  mutate(p.value = format.pval(p.value, digits = 3))

# Model where FEV1/FVC is the primary predictor. 
rp_fev1_fvc_mod <- gam(log_psill ~ s(slice_normalized,bs = "ps",m = c(2,2)) +
                         BMI + Age + Gender + Height + s(ID,bs = "re") + 
                         s(slice_normalized,by = POSTFEVFVC,bs = "ps"), 
                       data = right_lung_data, family = gaussian, method = "ML") 

rp_fev1_fvc_mod_sum <- tidy(rp_fev1_fvc_mod, parametric = T) %>%
  select(term, estimate, std.error, p.value) %>%
  mutate(p.value = format.pval(p.value, digits = 3))

# Right Lung log(Range) models including race. 

# Model where Fibrosis is the primary predictor.
rr_fib_race_mod <- gam(log_range ~ s(slice_normalized,bs = "ps",m = c(2,2)) +
                         BMI + Age + Gender + Height + Race + s(ID,bs = "re") + 
                         s(slice_normalized,by = Fibrosis,bs = "ps"), 
                       data = right_lung_data, family = gaussian, method = "ML")

rr_fib_race_mod_sum <- tidy(rr_fib_race_mod, parametric = T) %>%
  select(term, estimate, std.error, p.value) %>%
  mutate(p.value = format.pval(p.value, digits = 3))

# Model where Mediastinal Lymphadenopathy is the primary predictor.
rr_med_race_mod <- gam(log_range ~ s(slice_normalized,bs = "ps",m = c(2,2)) +
                         BMI + Age + Gender + Height + Race + s(ID,bs = "re") + 
                         s(slice_normalized,by = Med_Lymphadenopathy,bs = "ps"), 
                       data = right_lung_data, family = gaussian, method = "ML")

rr_med_race_mod_sum <- tidy(rr_med_race_mod, parametric = T) %>%
  select(term, estimate, std.error, p.value) %>%
  mutate(p.value = format.pval(p.value, digits = 3))

# Model where Traction Bronchiectasis is the primary predictor. 
rr_tra_race_mod <- gam(log_range ~ s(slice_normalized,bs = "ps",m = c(2,2)) +
                         BMI + Age + Gender + Height + Race + s(ID,bs = "re") + 
                         s(slice_normalized,by = Traction_Bronchiectasis,bs = "ps"), 
                       data = right_lung_data, family = gaussian, method = "ML")

rr_tra_race_mod_sum <- tidy(rr_tra_race_mod, parametric = T) %>%
  select(term, estimate, std.error, p.value) %>%
  mutate(p.value = format.pval(p.value, digits = 3))

# Model where FEV1 is the primary predictor. 
rr_fev1_race_mod <- gam(log_range ~ s(slice_normalized,bs = "ps",m = c(2,2)) + 
                          BMI + Age + Gender + Height + Race + s(ID,bs = "re") + 
                          s(slice_normalized,by = POSTFEV1,bs = "ps"), 
                        data = right_lung_data, family = gaussian, method = "ML")

rr_fev1_race_mod_sum <- tidy(rr_fev1_race_mod, parametric = T) %>%
  select(term, estimate, std.error, p.value) %>%
  mutate(p.value = format.pval(p.value, digits = 3))

# Model where FVC is the primary predictor. 
rr_fvc_race_mod <- gam(log_range ~ s(slice_normalized,bs = "ps",m = c(2,2)) +
                         BMI + Age + Gender + Height + Race + s(ID,bs = "re") + 
                         s(slice_normalized,by = POSTFVC,bs = "ps"), 
                       data = right_lung_data, family = gaussian, method = "ML") 

rr_fvc_race_mod_sum <- tidy(rr_fvc_race_mod, parametric = T) %>%
  select(term, estimate, std.error, p.value) %>%
  mutate(p.value = format.pval(p.value, digits = 3))

# Model where FEV1/FVC is the primary predictor. 
rr_fev1_fvc_race_mod <- gam(log_range ~ s(slice_normalized,bs = "ps",m = c(2,2)) +
                              BMI + Age + Gender + Height + Race + s(ID,bs = "re") + 
                              s(slice_normalized,by = POSTFEVFVC,bs = "ps"), 
                            data = right_lung_data, family = gaussian, method = "ML") 

rr_fev1_fvc_race_mod_sum <- tidy(rr_fev1_fvc_race_mod, parametric = T) %>%
  select(term, estimate, std.error, p.value) %>%
  mutate(p.value = format.pval(p.value, digits = 3))

# Right lung log(Range) models not including race. 

# Model where Fibrosis is the primary predictor.
rr_fib_mod <- gam(log_range ~ s(slice_normalized,bs = "ps",m = c(2,2)) +
                    BMI + Age + Gender + Height + s(ID,bs = "re") +
                    s(slice_normalized,by = Fibrosis,bs = "ps"),
                  data = right_lung_data, family = gaussian, method = "ML")

rr_fib_mod_sum <- tidy(rr_fib_mod, parametric = T) %>%
  select(term, estimate, std.error, p.value) %>%
  mutate(p.value = format.pval(p.value, digits = 3))

# Model where Mediastinal Lymphadenopathy is the primary predictor.
rr_med_mod <- gam(log_range ~ s(slice_normalized,bs = "ps",m = c(2,2)) +
                    BMI + Age + Gender + Height + s(ID,bs = "re") + 
                    s(slice_normalized,by = Med_Lymphadenopathy,bs = "ps"), 
                  data = right_lung_data, family = gaussian, method = "ML")

rr_med_mod_sum <- tidy(rr_med_mod, parametric = T) %>%
  select(term, estimate, std.error, p.value) %>%
  mutate(p.value = format.pval(p.value, digits = 3))

# Model where Traction Bronchiectasis is the primary predictor. 
rr_tra_mod <- gam(log_range ~ s(slice_normalized,bs = "ps",m = c(2,2)) +
                    BMI + Age + Gender + Height + s(ID,bs = "re") + 
                    s(slice_normalized,by = Traction_Bronchiectasis,bs = "ps"), 
                  data = right_lung_data, family = gaussian, method = "ML")

rr_tra_mod_sum <- tidy(rr_tra_mod, parametric = T) %>%
  select(term, estimate, std.error, p.value) %>%
  mutate(p.value = format.pval(p.value, digits = 3))

# Model where FEV1 is the primary predictor. 
rr_fev1_mod <- gam(log_range ~ s(slice_normalized,bs = "ps",m = c(2,2)) + 
                     BMI + Age + Gender + Height + s(ID,bs = "re") +
                     s(slice_normalized,by = POSTFEV1,bs = "ps"),
                   data = right_lung_data, family = gaussian, method = "ML")

rr_fev1_mod_sum <- tidy(rr_fev1_mod, parametric = T) %>%
  select(term, estimate, std.error, p.value) %>%
  mutate(p.value = format.pval(p.value, digits = 3))

# Model where FVC is the primary predictor. 
rr_fvc_mod <- gam(log_range ~ s(slice_normalized,bs = "ps",m = c(2,2)) +
                    BMI + Age + Gender + Height + s(ID,bs = "re") +
                    s(slice_normalized,by = POSTFVC,bs = "ps"),
                  data = right_lung_data, family = gaussian, method = "ML") 

rr_fvc_mod_sum <- tidy(rr_fvc_mod, parametric = T) %>%
  select(term, estimate, std.error, p.value) %>%
  mutate(p.value = format.pval(p.value, digits = 3))

# Model where FEV1/FVC is the primary predictor. 
rr_fev1_fvc_mod <- gam(log_range ~ s(slice_normalized,bs = "ps",m = c(2,2)) +
                         BMI + Age + Gender + Height + s(ID,bs = "re") + 
                         s(slice_normalized,by = POSTFEVFVC,bs = "ps"), 
                       data = right_lung_data, family = gaussian, method = "ML") 

rr_fev1_fvc_mod_sum <- tidy(rr_fev1_fvc_mod, parametric = T) %>%
  select(term, estimate, std.error, p.value) %>%
  mutate(p.value = format.pval(p.value, digits = 3))

gam_models <- list(lp_fib_race_mod,lp_med_race_mod,lp_tra_race_mod,lp_fev1_race_mod,
                   lp_fvc_race_mod,lp_fev1_fvc_race_mod,lp_fib_mod,lp_med_mod,
                   lp_tra_mod,lp_fev1_mod,lp_fvc_mod,lp_fev1_fvc_mod,lr_fib_race_mod,
                   lr_med_race_mod,lr_tra_race_mod,lr_fev1_race_mod,lr_fvc_race_mod,
                   lr_fev1_fvc_race_mod,lr_fib_mod,lr_med_mod,lr_tra_mod,lr_fev1_mod,
                   lr_fvc_mod,lr_fev1_fvc_mod,rp_fib_race_mod,rp_med_race_mod,rp_tra_race_mod,
                   rp_fev1_race_mod,rp_fvc_race_mod,rp_fev1_fvc_race_mod,rp_fib_mod,
                   rp_med_mod,rp_tra_mod,rp_fev1_mod,rp_fvc_mod,rp_fev1_fvc_mod,
                   rr_fib_race_mod,rr_med_race_mod,rr_tra_race_mod,rr_fev1_race_mod,
                   rr_fvc_race_mod,rr_fev1_fvc_race_mod,rr_fib_mod,rr_med_mod,rr_tra_mod,
                   rr_fev1_mod,rr_fvc_mod,rr_fev1_fvc_mod)

names(gam_models) <- c("left_psill_fibrosis_race_mod","left_psill_mediastinal_lymphadenopathy_race_mod",
                       "left_psill_traction_bronchiectasis_race_mod","left_psill_postfev1_race_mod",
                   "left_psill_postfvc_race_mod","left_psill_postfev1fvc_race_mod",
                   "left_psill_fibrosis_no_race_mod","left_psill_mediastinal_lymphadenopathy_no_race_mod",
                   "left_psill_traction_bronchiectasis_no_race_mod","left_psill_postfev1_no_race_mod",
                   "left_psill_postfvc_no_race_mod","left_psill_postfev1fvc_no_race_mod",
                   "left_range_fibrosis_race_mod","left_range_mediastinal_lymphadenopathy_race_mod",
                   "left_range_traction_bronchiectasis_race_mod","left_range_postfev1_race_mod",
                   "left_range_postfvc_race_mod","left_range_postfev1fvc_race_mod","left_range_fibrosis_no_race_mod",
                   "left_range_mediastinal_lymphadenopathy_no_race_mod","left_range_traction_bronchiectasis_no_race_mod",
                   "left_range_postfev1_no_race_mod","left_range_postfvc_no_race_mod",
                   "left_range_postfev1fvc_no_race_mod","right_psill_fibrosis_race_mod",
                   "right_psill_mediastinal_lymphadenopathy_race_mod","right_psill_traction_bronchiectasis_race_mod",
                   "right_psill_postfev1_race_mod","right_psill_postfvc_race_mod",
                   "right_psill_postfev1fvc_race_mod","right_psill_fibrosis_no_race_mod",
                   "right_psill_mediastinal_lymphadenopathy_no_race_mod",
                   "right_psill_traction_bronchiectasis_no_race_mod","right_psill_postfev1_no_race_mod",
                   "right_psill_postfvc_no_race_mod","right_psill_postfev1fvc_no_race_mod",
                   "right_range_fibrosis_race_mod","right_range_mediastinal_lymphadenopathy_race_mod",
                   "right_range_traction_bronchiectasis_race_mod","right_range_postfev1_race_mod",
                   "right_range_postfvc_race_mod","right_range_postfev1fvc_race_mod",
                   "right_range_fibrosis_no_race_mod","right_range_mediastinal_lymphadenopathy_no_race_mod",
                   "right_range_traction_bronchiectasis_no_race_mod","right_range_postfev1_no_race_mod",
                   "right_range_postfvc_no_race_mod","right_range_postfev1fvc_no_race_mod")

# Saving data. Commented out to not accidentally run. 
#save(gam_models,file = "C:/Users/domin/Documents/Biostatistics Masters Program/Fall 2023/BIOS 6643 - ADL/BIOS6643_ALD/Final Project/ProcessedData/saved_gam_models.RData")

```

```

```{r prediction_setup, echo = F}

# Setting up parameters for making plots. 
fev1_quantiles <- quantile(project2_data$POSTFEV1,
                           probs = c(0.25,0.50,0.75)) 

fvc_quantiles <- quantile(project2_data$POSTFVC,
                          probs = c(0.25,0.50,0.75))

fev1fvc_quantiles <- quantile(project2_data$POSTFEVFVC,
                              probs = c(0.25,0.50,0.75))

bmi_mean <- mean(project2_data$BMI)

age_mean <- mean(project2_data$Age)

height_mean <- mean(project2_data$Height)

gender_select <- "Female"

race_select <- "Black or African American"

slice_normalized_vec <- seq(0.1,0.9,by = 0.001)

ID_pred <- "01S001"

```
\doublespacing
# Introduction 

Sarcoidosis is a potentially lethal disease with ~ 25,000 new cases diagnosed in the United States each year. The disease is characterized by granulomas, and the vast majority (90\%) of cases primarily affect the lung. Currently, the standard in care for assessing sarcoidosis are lung images utilizing computed tomography (CT). While this method provides better characterizing of abnormalities compared to chest x-rays there are two primary problems; 1.) CT is primarily based on visual assessment, resulting in high inter- and intra-rater variation, and 2.) these visual assessments are not strongly predictive of disease course. Recently, a new method to better quantify measures of lung CT has been developed utilizing variograms. Variograms are a standard geostatistical too for measuring and modelling spatial covariance within an image, as well as spatial process as a function of distance between points. 

Variogram data is typically represented by three parameters: 1.) the sill, 2.) the range, and 3.) the nugget. The sill is the overall variation present in an image, the range represents the spatial scale of correlation, and the nugget is the variation due to measurement error. For sufficiently high resolution images the nugget is 0, which will be assumed for this analysis. The location of each individual scan is represented by the normalized slice variable spanning 0 to 1, corresponding to the bottom and top of the lung respectively. 

The purpose of this analysis is to answer two primary questions of interest: 

*Should race be included as a demographic feature that is adjusted for?*

*How do clinical measures of disease associate with the lungs after adjusting for demographics?*

There are six total clinical measures of disease. Three of these are PFT measurements: FEV1 (Forced Expiratory Volume in 1 second), FVC (Forced Vital Capacity), and FEV1/FVC ratio (provided as a fraction). The other three are VAS (Visual Assessment Scores): fibrosis, mediastinal lymphadenopathy, and traction bronchiectasis. Demographics other than race are BMI, age, sex, and height. Analysis will involve comparing models with and without race to determine the impact of including this as a demographic feature, and plots will be presented to illustrated trends in clinical features for both sill and range. Additionally, further research on the ethical and clinical/scientific justification for inclusion of race as a predictor in sarcoidosis was performed.

# Methods 

### Data 

The data for this analysis was compiled from two main sources, clinical measurements and variogram measurements. The clinical measurements provided the demographic data and the PFT and VAS measurements, and included 368 subjects. Cleaning the clinical data involved several steps. For simplicity in modeling VAS measurements were considered a binary indicating presence of the condition or no presence of the condition. Both traction bronchiectasis and mediastinal lymphadenopathy had four potential levels, which were then collapsed into binary indicators. Fibrosis was already a binary variable, meaning this step was not necessary for this variable. The construction of the race variable involved combining the provided race and ethnicity variables. The race categories initially had 6 possible options, Black or African American, American Indian or Alaskan Native, white, multi-racial or no primary race, Asian, and unknown. The ethnicity variable denoted whether a subject was Hispanic or not Hispanic. The race variable used in this analysis first involved separating white subjects into Hispanic white and non-Hispanic white. After this race was collapsed into three categories: 1.) non-Hispanic white, 2.) Black or African American, 3.) and other, which incorporated American Indian or Alaskan Native, multi-racial or no primary race, Asian, unknown, and Hispanic white. Two important features are that subjects who were missing race/ethnicity data were considered "NA", which is distinct from the "unknown" category, and the majority of subjects were non-Hispanic white, followed by Black or African American. The composite category of "other" had the smallest amount of subjects. 

Variogram data included information regarding the subject ID for each measurement, as well as which lung each measurement came from. Variogram measurements had three components, the range, the psill, and the slice normalized variable, which indicated location in the lung. Values closer to 0 correspond to the bottom of the lung, and values closer to 1 correspond to the top of the lung. For this analysis normalized slice values between 0.1 and 0.9 were used to avoid measurement variations of the top and bottom-most portion of scans. In general each subject had 50 slices per lung, meaning a total of 100 scans per subject. Two subjetc were dropped during initial data cleaning, one due to an outlier in the range measurement (> 300), and another due to missing data on the left lung. Out of the original 342 subject 340 were kept after dropping these two. Lastly, psill and range were log transformed due to prominant right-skew in the distribution of each.  

After initial cleaning both data sets were combined. As there were more subject with clinical data than variogram data the subject IDs for variogram data were used for the combining, resulting in a composite data frame of 342 subjects. A complete case analysis was performed, meaning subjects missing any of relevant demographic data were dropped from the analysis. After dropping there were 320 subjects total. 

### Analysis

Analysis utilized cubic penalized splines with 4 degrees of freedom to model the relationship between location in the lung and each of the two variogram predictors (psill and range). This approach allowed for non-linear associations between the clinical predictors and location in the lung. Outcomes for both psill and range were considered Gaussian-distributed. Models for each clinical predictor were made separately, with each outcome being having its own model, and each lung having its own model. Additionally, models including race and excluding race were compared. In total, each clinical predictor had 4 models for each outcome (right lung psill and range, left lung psill and range) including race and 4 models for each outcome excluding race. Between the six predictors this results in a total of 48 models. Additional models parameters include demographic data beyond race (BMI, age, sex, height), and a subject-specific random effect. 

Models including and excluding race were compared with AIC, where lower scores indicate better model fitting. Plots of trend within the lung for each model were included to understand how each clinical predictor affects psill and range measurements, with point estimates and 95\% confidence intervals included in the plots. The VAS predictors are stratified into yes/no, and the PFT measurements are stratified into the 25th percentile, 50th percentile, and 75th percentile for subjects in the cohort. For plots predicted values were based on a subject who is an African American/Black female who is the average age (53 years), average BMI (30.6), and average height(67 inches) for all subjects in the cohort.  

Additional literature analysis regarding the inclusion/exclusion of race as a predictor was included when discussing significance of the results. For this analysis the category of "Black or African American" will be the reference group against which "non-Hispanic white" and "other" will be compared. All analysis were performed in R version 4.3.1. 

\singlespacing
# Results

### Direct Model Comparison 

```{r aic_table, echo = F}

# Making a table illustrating the AIC values for each model. 
fibrosis_aic <- data.frame(matrix(c(gam_models$left_psill_fibrosis_race_mod$aic,
                                    gam_models$right_psill_fibrosis_race_mod$aic,
                                    gam_models$left_range_fibrosis_race_mod$aic,
                                    gam_models$right_range_fibrosis_race_mod$aic,
                                    gam_models$left_psill_fibrosis_no_race_mod$aic,
                                    gam_models$right_psill_fibrosis_no_race_mod$aic,
                                    gam_models$left_range_fibrosis_no_race_mod$aic,
                                    gam_models$right_range_fibrosis_no_race_mod$aic),
                                  ncol = 4,byrow = T))



med_lymph_aic <- data.frame(matrix(c(gam_models$left_psill_mediastinal_lymphadenopathy_race_mod$aic,
                                     gam_models$right_psill_mediastinal_lymphadenopathy_race_mod$aic,
                                     gam_models$left_range_mediastinal_lymphadenopathy_race_mod$aic,
                                     gam_models$right_range_mediastinal_lymphadenopathy_race_mod$aic,
                                     gam_models$left_psill_mediastinal_lymphadenopathy_no_race_mod$aic,
                                     gam_models$right_psill_mediastinal_lymphadenopathy_no_race_mod$aic,
                                     gam_models$left_range_mediastinal_lymphadenopathy_no_race_mod$aic,
                                     gam_models$right_range_mediastinal_lymphadenopathy_no_race_mod$aic),
                                   ncol = 4, byrow = T))

trac_bronch_aic <- data.frame(matrix(c(gam_models$left_psill_traction_bronchiectasis_race_mod$aic,
                                       gam_models$right_psill_traction_bronchiectasis_race_mod$aic,
                                       gam_models$left_range_traction_bronchiectasis_race_mod$aic,
                                       gam_models$right_range_traction_bronchiectasis_race_mod$aic,
                                       gam_models$left_psill_traction_bronchiectasis_no_race_mod$aic,
                                       gam_models$right_psill_traction_bronchiectasis_no_race_mod$aic,
                                       gam_models$left_range_traction_bronchiectasis_no_race_mod$aic,
                                       gam_models$right_range_traction_bronchiectasis_no_race_mod$aic),
                                     ncol = 4, byrow = T))

fev1_aic <- data.frame(matrix(c(gam_models$left_psill_postfev1_race_mod$aic,
                                gam_models$right_psill_postfev1_race_mod$aic,
                                gam_models$left_range_postfev1_race_mod$aic,
                                gam_models$right_range_postfev1_race_mod$aic,
                                gam_models$left_psill_postfev1_no_race_mod$aic,
                                gam_models$right_psill_postfev1_no_race_mod$aic,
                                gam_models$left_range_postfev1_no_race_mod$aic,
                                gam_models$right_range_postfev1_no_race_mod$aic),
                              ncol = 4, byrow = T))

fvc_aic <- data.frame(matrix(c(gam_models$left_psill_postfvc_race_mod$aic,
                               gam_models$right_psill_postfvc_race_mod$aic,
                               gam_models$left_range_postfvc_race_mod$aic,
                               gam_models$right_range_postfvc_race_mod$aic,
                               gam_models$left_psill_postfvc_no_race_mod$aic,
                               gam_models$right_psill_postfvc_no_race_mod$aic,
                               gam_models$left_range_postfvc_no_race_mod$aic,
                               gam_models$right_range_postfvc_no_race_mod$aic),
                             ncol = 4, byrow = T))

fev1fvc_aic <- data.frame(matrix(c(gam_models$left_psill_postfev1fvc_race_mod$aic,
                                   gam_models$right_psill_postfev1fvc_race_mod$aic,
                                   gam_models$left_range_postfev1fvc_race_mod$aic,
                                   gam_models$right_range_postfev1fvc_race_mod$aic,
                                   gam_models$left_psill_postfev1fvc_no_race_mod$aic,
                                   gam_models$right_psill_postfev1fvc_no_race_mod$aic,
                                   gam_models$left_range_postfev1fvc_no_race_mod$aic,
                                   gam_models$right_range_postfev1fvc_no_race_mod$aic),
                                 ncol = 4, byrow = T))

model_type <- rep(c("Including Race","Excluding Race"),times = 6)

aic_df <- cbind(model_type,rbind(fibrosis_aic,med_lymph_aic,trac_bronch_aic,
                fev1_aic,fvc_aic,fev1fvc_aic))

aic_table <- kbl(aic_df,
                 caption = "AIC Across Models",
                 col.names = c("Model Type","Left","Right","Left","Right"),
                 booktabs = TRUE, align = "rcccc") %>%
  kable_styling(full_width = F, latex_options = c("HOLD_position"),font_size = 9) %>%
  add_header_above(c(" ","Psill" = 2, "Range" = 2)) %>%
  group_rows("Fibrosis",1,2) %>%
  group_rows("Mediastinal Lymphadenopathy",3,4) %>%
  group_rows("Traction Bronchiectasis",5,6) %>%
  group_rows("FEV1",7,8) %>%
  group_rows("FVC",9,10) %>%
  group_rows("FEV1/FVC",11,12)

aic_table

```
\doublespacing
The table above compares AIC values between different models including and excluding race as a predictor. Psill models including race have a lower AIC for fibrosis, mediastinal lymphadenopahty, traction bronchiectasis, and FEV1/FVC. For FEV1 and FVC, psill models excluding race have a lower AIC. However, the delta in AIC between models including and excluding race are less than 1, suggesting that both models perform similarly. 

Range models excluding race have lower AIC score compared to models including race. Again, the differences are less than 1 suggesting that these models perform similarly. Between both lungs and both outcomes models excluding race have a higher proportion of lower AIC values compared to models including race. 


\singlespacing
### Fibrosis

```{r fibrosis_table_setup, echo = F}

# Making tables for fibrosis results. 

terms_with_race <- c("Intercept","BMI","Age","Male","Height","Other Races",
                     "Non-Hispanic White","s(Slice)","s(ID)")

terms_without_race <- c("Intercept","BMI","Age","Male","Height",
                        "s(Slice)","s(ID)")

pl_fibrosis_race_tbl_df <- rbind.fill(broom::tidy(gam_models$left_psill_fibrosis_race_mod,
                                       parametric = T),broom::tidy(gam_models$left_psill_fibrosis_race_mod,
                                                                   parametric = F)) %>%
  select(term,estimate,std.error,p.value,edf,ref.df) %>%
  mutate(p.value = format.pval(p.value,digits = 1),
         term = c(terms_with_race,"s(Slice):Fibrosis"))

pr_fibrosis_race_tbl_df <- rbind.fill(broom::tidy(gam_models$right_psill_fibrosis_race_mod,
                                                  parametric = T),broom::tidy(gam_models$right_psill_fibrosis_race_mod,
                                                                              parametric = F)) %>%
  select(estimate,std.error,p.value,edf,ref.df) %>%
  mutate(p.value = format.pval(p.value,digits = 1))

pl_fibrosis_no_race_tbl_df <- rbind.fill(broom::tidy(gam_models$left_psill_fibrosis_no_race_mod,
                                                     parametric = T),broom::tidy(gam_models$left_psill_fibrosis_no_race_mod,
                                                                               parametric = F)) %>%
  select(term,estimate,std.error,p.value,edf,ref.df) %>%
  mutate(p.value = format.pval(p.value,digits = 1),
         term = c(terms_without_race,"s(Slice):Fibrosis"))

pr_fibrosis_no_race_tbl_df <- rbind.fill(broom::tidy(gam_models$right_psill_fibrosis_no_race_mod,
                                                     parametric = T),broom::tidy(gam_models$right_psill_fibrosis_no_race_mod,
                                                                                 parametric = F)) %>%
  select(estimate,std.error,p.value,edf,ref.df) %>%
  mutate(p.value = format.pval(p.value,digits = 1))

rl_fibrosis_race_tbl_df <- rbind.fill(broom::tidy(gam_models$left_range_fibrosis_race_mod,
                                                  parametric = T),broom::tidy(gam_models$left_range_fibrosis_race_mod,
                                                                              parametric = F)) %>%
  select(term,estimate,std.error,p.value,edf,ref.df) %>%
  mutate(p.value = format.pval(p.value,digits = 1),
         term = c(terms_with_race,"s(Slice):Fibrosis"))

rr_fibrosis_race_tbl_df <- rbind.fill(broom::tidy(gam_models$right_range_fibrosis_race_mod,
                                                  parametric = T),broom::tidy(gam_models$right_range_fibrosis_race_mod,
                                                                              parametric = F)) %>%
  select(estimate,std.error,p.value,edf,ref.df) %>%
  mutate(p.value = format.pval(p.value,digits = 1))

rl_fibrosis_no_race_tbl_df <- rbind.fill(broom::tidy(gam_models$left_range_fibrosis_no_race_mod,
                                                     parametric = T),broom::tidy(gam_models$left_range_fibrosis_no_race_mod,
                                                                                parametric = F)) %>%
  select(term,estimate,std.error,p.value,edf,ref.df) %>%
  mutate(p.value = format.pval(p.value,digits = 1),
         term = c(terms_without_race,"s(Slice):Fibrosis")) 

rr_fibrosis_no_race_tbl_df <- rbind.fill(broom::tidy(gam_models$right_range_fibrosis_no_race_mod,
                                                     parametric = T),broom::tidy(gam_models$right_range_fibrosis_no_race_mod,
                                                                                 parametric = F)) %>%
  select(estimate,std.error,p.value,edf,ref.df) %>%
  mutate(p.value = format.pval(p.value,digits = 1))

fibrosis_results_df <- rbind(cbind(pl_fibrosis_race_tbl_df,pr_fibrosis_race_tbl_df),
                             cbind(pl_fibrosis_no_race_tbl_df,pr_fibrosis_no_race_tbl_df),
                             cbind(rl_fibrosis_race_tbl_df,rr_fibrosis_race_tbl_df),
                             cbind(rl_fibrosis_no_race_tbl_df,rr_fibrosis_no_race_tbl_df))

fibrosis_results_table <- kbl(fibrosis_results_df,align = "rcccccc",digits = 4,
                              longtable = TRUE, booktabs = TRUE,
                              col.names = c("Term",rep(c("Estimate","SE","P-Value",
                                                         "EDF","Ref. DF"),2)),
                              caption = "Summary of Models for Fibrosis") %>%
  kable_styling(full_width = FALSE, latex_options = c("HOLD_position","repeat_header"),
                font_size = 7) %>%
  add_header_above(c(" ","Left Lung" = 5,"Right Lung" = 5),bold = TRUE) %>%
  pack_rows("Outcome: Psill | With Race",1,10) %>%
  pack_rows("Outcome: Psill | Without Race",11,18) %>%
  pack_rows("Outcome: Range | With Race",19,28) %>%
  pack_rows("Outcome: Range | Without Race",29,36) %>%
  row_spec(0, bold = TRUE) %>%
  column_spec(2:11, width = "3.5em")

```

```{r fibrosis_table, echo = F}

# Plotting table.
fibrosis_results_table

```
\doublespacing

The table above illustrates differences between models including and excluding race when fibrosis is the main clinical predictor. In all models the interaction between normalized slice and fibrosis is a significant predictor for range and psill values regardless of whether or not race was included as a predictor. For psill non-Hispanic white is a significant predictor for both lungs while the other race group is not. For range neither non-Hispanic white nor other race group are significant predictors in either lung. 

\singlespacing
```{r fibrosis_plots, echo = F, warning = F}

# Plotting left lung psill fibrosis model with race.
pl_fibrosis_race_pred_df <- expand.grid(BMI = bmi_mean,Age = age_mean,
                                        Height = height_mean, 
                                        Gender = gender_select,
                                        Race = race_select,
                                        slice_normalized = slice_normalized_vec,
                                        Fibrosis = c(0,1),ID = ID_pred)

pl_fibrosis_race_pred <- predict(gam_models$left_psill_fibrosis_race_mod,
                                 newdata = pl_fibrosis_race_pred_df,
                                 type = "response", exclude = "s(ID)",
                                 se.fit = TRUE)

pl_fibrosis_race_df <- data.frame(pl_fibrosis_race_pred_df,
                                  "Yhat" = pl_fibrosis_race_pred$fit,
                                  "LB" = pl_fibrosis_race_pred$fit -
                                    qnorm(0.975)*pl_fibrosis_race_pred$se.fit,
                                  "UB" = pl_fibrosis_race_pred$fit +
                                    qnorm(0.975)*pl_fibrosis_race_pred$se.fit)

pl_fibrosis_race_plot <- ggplot(pl_fibrosis_race_df, 
                                aes(x = slice_normalized,
                                    y = Yhat,
                                    color = factor(Fibrosis))) +
  geom_line() +
  geom_ribbon(aes(ymin = LB,ymax = UB,fill = factor(Fibrosis)),alpha = 0.1,
              linetype = "dotted") +
  labs(y = "Predicted log(Psill)",x = "",
       title = "Left Psill Fibrosis - With Race") +
  scale_fill_discrete(name = "Fibrosis",labels = c("No","Yes")) +
  guides(color = F) +
  theme_bw() +
  theme(axis.ticks.x = element_blank(),axis.text.x = element_blank()) 

# Plotting right lung psill fibrosis model with race. 
pr_fibrosis_race_pred_df <- expand.grid(BMI = bmi_mean,Age = age_mean,
                                        Height = height_mean, 
                                        Gender = gender_select,
                                        Race = race_select,
                                        slice_normalized = slice_normalized_vec,
                                        Fibrosis = c(0,1),ID = ID_pred)

pr_fibrosis_race_pred <- predict(gam_models$right_psill_fibrosis_race_mod,
                                 newdata = pr_fibrosis_race_pred_df,
                                 type = "response", exclude = "s(ID)",
                                 se.fit = TRUE)

pr_fibrosis_race_df <- data.frame(pr_fibrosis_race_pred_df,
                                  "Yhat" = pr_fibrosis_race_pred$fit,
                                  "LB" = pr_fibrosis_race_pred$fit -
                                    qnorm(0.975)*pr_fibrosis_race_pred$se.fit,
                                  "UB" = pr_fibrosis_race_pred$fit +
                                    qnorm(0.975)*pr_fibrosis_race_pred$se.fit)

pr_fibrosis_race_plot <- ggplot(pr_fibrosis_race_df, 
                                aes(x = slice_normalized,
                                    y = Yhat,
                                    color = factor(Fibrosis))) +
  geom_line() +
  geom_ribbon(aes(ymin = LB,ymax = UB,fill = factor(Fibrosis)),alpha = 0.1,
              linetype = "dotted") +
  labs(x = "",y = "",
    title = "Right Psill Fibrosis - With Race") +
  scale_fill_discrete(name = "Fibrosis",labels = c("No","Yes")) +
  guides(color = F) +
  theme_bw() +
  theme(axis.ticks.x = element_blank(),axis.text.x = element_blank()) 

# Plotting left lung psill fibrosis with no race.
pl_fibrosis_no_race_pred_df <- expand.grid(BMI = bmi_mean,Age = age_mean,
                                           Height = height_mean, 
                                           Gender = gender_select,
                                        slice_normalized = slice_normalized_vec,
                                        Fibrosis = c(0,1),ID = ID_pred)

pl_fibrosis_no_race_pred <- predict(gam_models$left_psill_fibrosis_no_race_mod,
                                 newdata = pl_fibrosis_no_race_pred_df,
                                 type = "response", exclude = "s(ID)",
                                 se.fit = TRUE)

pl_fibrosis_no_race_df <- data.frame(pl_fibrosis_no_race_pred_df,
                                  "Yhat" = pl_fibrosis_no_race_pred$fit,
                                  "LB" = pl_fibrosis_no_race_pred$fit -
                                    qnorm(0.975)*pl_fibrosis_no_race_pred$se.fit,
                                  "UB" = pl_fibrosis_no_race_pred$fit +
                                    qnorm(0.975)*pl_fibrosis_no_race_pred$se.fit)

pl_fibrosis_no_race_plot <- ggplot(pl_fibrosis_no_race_df, 
                                aes(x = slice_normalized,
                                    y = Yhat,
                                    color = factor(Fibrosis))) +
  geom_line() +
  geom_ribbon(aes(ymin = LB,ymax = UB,fill = factor(Fibrosis)),alpha = 0.1,
              linetype = "dotted") +
  labs(y = "Predicted log(Psill)",x = "",
       title = "Left Psill Fibrosis - No Race") +
  scale_fill_discrete(name = "Fibrosis",labels = c("No","Yes")) +
  guides(color = F) +
  theme_bw() +
  theme(axis.ticks.x = element_blank(),axis.text.x = element_blank())

# Plotting right lung psill fibrosis with no race.
pr_fibrosis_no_race_pred_df <- expand.grid(BMI = bmi_mean,Age = age_mean,
                                           Height = height_mean, 
                                           Gender = gender_select,
                                        slice_normalized = slice_normalized_vec,
                                        Fibrosis = c(0,1),ID = ID_pred)

pr_fibrosis_no_race_pred <- predict(gam_models$right_psill_fibrosis_no_race_mod,
                                 newdata = pr_fibrosis_no_race_pred_df,
                                 type = "response", exclude = "s(ID)",
                                 se.fit = TRUE)

pr_fibrosis_no_race_df <- data.frame(pr_fibrosis_no_race_pred_df,
                                  "Yhat" = pr_fibrosis_no_race_pred$fit,
                                  "LB" = pr_fibrosis_no_race_pred$fit -
                                    qnorm(0.975)*pr_fibrosis_no_race_pred$se.fit,
                                  "UB" = pr_fibrosis_no_race_pred$fit +
                                    qnorm(0.975)*pr_fibrosis_no_race_pred$se.fit)

pr_fibrosis_no_race_plot <- ggplot(pr_fibrosis_no_race_df, 
                                aes(x = slice_normalized,
                                    y = Yhat,
                                    color = factor(Fibrosis))) +
  geom_line() +
  geom_ribbon(aes(ymin = LB,ymax = UB,fill = factor(Fibrosis)),alpha = 0.1,
              linetype = "dotted") +
  labs(x = "",y = "",
    title = "Right Psill Fibrosis - No Race") +
  scale_fill_discrete(name = "Fibrosis",labels = c("No","Yes")) +
  guides(color = F) +
  theme_bw() +
  theme(axis.ticks.x = element_blank(),axis.text.x = element_blank())

# Plotting left lung range fibrosis model with race.
rl_fibrosis_race_pred_df <- expand.grid(BMI = bmi_mean,Age = age_mean,
                                        Height = height_mean, 
                                        Gender = gender_select,
                                        Race = race_select,
                                        slice_normalized = slice_normalized_vec,
                                        Fibrosis = c(0,1),ID = ID_pred)

rl_fibrosis_race_pred <- predict(gam_models$left_range_fibrosis_race_mod,
                                 newdata = rl_fibrosis_race_pred_df,
                                 type = "response", exclude = "s(ID)",
                                 se.fit = TRUE)

rl_fibrosis_race_df <- data.frame(rl_fibrosis_race_pred_df,
                                  "Yhat" = rl_fibrosis_race_pred$fit,
                                  "LB" = rl_fibrosis_race_pred$fit -
                                    qnorm(0.975)*rl_fibrosis_race_pred$se.fit,
                                  "UB" = rl_fibrosis_race_pred$fit +
                                    qnorm(0.975)*rl_fibrosis_race_pred$se.fit)

rl_fibrosis_race_plot <- ggplot(rl_fibrosis_race_df, 
                                aes(x = slice_normalized,
                                    y = Yhat,
                                    color = factor(Fibrosis))) +
  geom_line() +
  geom_ribbon(aes(ymin = LB,ymax = UB,fill = factor(Fibrosis)),alpha = 0.1,
              linetype = "dotted") +
  labs(y = "Predicted log(Range)", x = "",
       title = "Left Range Fibrosis - With Race") +
  scale_fill_discrete(name = "Fibrosis",labels = c("No","Yes")) +
  guides(color = F) +
  theme_bw() +
  theme(axis.ticks.x = element_blank(),axis.text.x = element_blank()) 

# Plotting right lung range fibrosis model with race.
rr_fibrosis_race_pred_df <- expand.grid(BMI = bmi_mean,Age = age_mean,
                                        Height = height_mean, 
                                        Gender = gender_select,
                                        Race = race_select,
                                        slice_normalized = slice_normalized_vec,
                                        Fibrosis = c(0,1),ID = ID_pred)

rr_fibrosis_race_pred <- predict(gam_models$right_range_fibrosis_race_mod,
                                 newdata = rr_fibrosis_race_pred_df,
                                 type = "response", exclude = "s(ID)",
                                 se.fit = TRUE)

rr_fibrosis_race_df <- data.frame(rr_fibrosis_race_pred_df,
                                  "Yhat" = rr_fibrosis_race_pred$fit,
                                  "LB" = rr_fibrosis_race_pred$fit -
                                    qnorm(0.975)*rr_fibrosis_race_pred$se.fit,
                                  "UB" = rr_fibrosis_race_pred$fit +
                                    qnorm(0.975)*rr_fibrosis_race_pred$se.fit)

rr_fibrosis_race_plot <- ggplot(rr_fibrosis_race_df, 
                                aes(x = slice_normalized,
                                    y = Yhat,
                                    color = factor(Fibrosis))) +
  geom_line() +
  geom_ribbon(aes(ymin = LB,ymax = UB,fill = factor(Fibrosis)),alpha = 0.1,
              linetype = "dotted") +
  labs(x = "",y = "",
    title = "Right Range Fibrosis - With Race") +
  scale_fill_discrete(name = "Fibrosis",labels = c("No","Yes")) +
  guides(color = F) +
  theme_bw() +
  theme(axis.ticks.x = element_blank(),axis.text.x = element_blank()) 

# Plotting left lung range fibrosis model with no race.
rl_fibrosis_no_race_pred_df <- expand.grid(BMI = bmi_mean,Age = age_mean,
                                        Height = height_mean, 
                                        Gender = gender_select,
                                        slice_normalized = slice_normalized_vec,
                                        Fibrosis = c(0,1),ID = ID_pred)

rl_fibrosis_no_race_pred <- predict(gam_models$left_range_fibrosis_no_race_mod,
                                 newdata = rl_fibrosis_no_race_pred_df,
                                 type = "response", exclude = "s(ID)",
                                 se.fit = TRUE)

rl_fibrosis_no_race_df <- data.frame(rl_fibrosis_no_race_pred_df,
                                  "Yhat" = rl_fibrosis_no_race_pred$fit,
                                  "LB" = rl_fibrosis_no_race_pred$fit -
                                    qnorm(0.975)*rl_fibrosis_no_race_pred$se.fit,
                                  "UB" = rl_fibrosis_no_race_pred$fit +
                                    qnorm(0.975)*rl_fibrosis_no_race_pred$se.fit)

rl_fibrosis_no_race_plot <- ggplot(rl_fibrosis_no_race_df, 
                                aes(x = slice_normalized,
                                    y = Yhat,
                                    color = factor(Fibrosis))) +
  geom_line() +
  geom_ribbon(aes(ymin = LB,ymax = UB,fill = factor(Fibrosis)),alpha = 0.1,
              linetype = "dotted") +
  labs(x = "Normalized Slice",y = "Predicted log(Range)",
       title = "Left Range Fibrosis - No Race") +
  scale_fill_discrete(name = "Fibrosis",labels = c("No","Yes")) +
  guides(color = F) +
  theme_bw()

# Plotting right lung range fibrosis model with no race.
rr_fibrosis_no_race_pred_df <- expand.grid(BMI = bmi_mean,Age = age_mean,
                                        Height = height_mean, 
                                        Gender = gender_select,
                                        slice_normalized = slice_normalized_vec,
                                        Fibrosis = c(0,1),ID = ID_pred)

rr_fibrosis_no_race_pred <- predict(gam_models$right_range_fibrosis_no_race_mod,
                                 newdata = rr_fibrosis_no_race_pred_df,
                                 type = "response", exclude = "s(ID)",
                                 se.fit = TRUE)

rr_fibrosis_no_race_df <- data.frame(rr_fibrosis_no_race_pred_df,
                                  "Yhat" = rr_fibrosis_no_race_pred$fit,
                                  "LB" = rr_fibrosis_no_race_pred$fit -
                                    qnorm(0.975)*rr_fibrosis_no_race_pred$se.fit,
                                  "UB" = rr_fibrosis_no_race_pred$fit +
                                    qnorm(0.975)*rr_fibrosis_no_race_pred$se.fit)

rr_fibrosis_no_race_plot <- ggplot(rr_fibrosis_no_race_df, 
                                aes(x = slice_normalized,
                                    y = Yhat,
                                    color = factor(Fibrosis))) +
  geom_line() +
  geom_ribbon(aes(ymin = LB,ymax = UB,fill = factor(Fibrosis)),alpha = 0.1,
              linetype = "dotted") +
  labs(x = "Normalized Slice", y = "",
       title = "Right Range Fibrosis - No Race") +
  scale_fill_discrete(name = "Fibrosis",labels = c("No","Yes")) +
  guides(color = F) +
  theme_bw() 

```

```{r fibrosis_plot_print, echo = F,warning = F,fig.height = 8}

# Formatting plots for fibrosis. 
(pl_fibrosis_race_plot + pr_fibrosis_race_plot)/(pl_fibrosis_no_race_plot + pr_fibrosis_no_race_plot) /
  (rl_fibrosis_race_plot + rr_fibrosis_race_plot)/(rl_fibrosis_no_race_plot + rr_fibrosis_no_race_plot)

```
\doublespacing
The plots above show the trend range and psill when moving up the lung (normalized slice) when fibrosis is the main clinical predictor. Between the race and no race plots the trends are very similar, and subsequent analysis of fibrosis will consider the models with no race. For psill the left and right lung both show similar trends where those without fibrosis have noticeably lower psill when moving up the lung. In the lower portion of the lung there is almost no difference between those with and without fibrosis, with the confidence intervals overlapping. For range the left and right plots again show similar trends, where those without fibrosis have lower values compared to subjects who have fibrosis when moving up the lung. In the bottom portion of the lung there is again overlap. 

\singlespacing
### Mediastinal Lymphadenopathy (ML)

```{r med_lymph_table_setup, echo = F}

# Making tables for Mediastinal Lymphadenopathy results. 

pl_ml_race_tbl_df <- rbind.fill(broom::tidy(gam_models$left_psill_mediastinal_lymphadenopathy_race_mod,
                                       parametric = T),broom::tidy(gam_models$left_psill_mediastinal_lymphadenopathy_race_mod,
                                                                   parametric = F)) %>%
  select(term,estimate,std.error,p.value,edf,ref.df) %>%
  mutate(p.value = format.pval(p.value,digits = 1),
         term = c(terms_with_race,"s(Slice):ML"))

pr_ml_race_tbl_df <- rbind.fill(broom::tidy(gam_models$right_psill_mediastinal_lymphadenopathy_race_mod,
                                                  parametric = T),
                                broom::tidy(gam_models$right_psill_mediastinal_lymphadenopathy_race_mod,
                                                                              parametric = F)) %>%
  select(estimate,std.error,p.value,edf,ref.df) %>%
  mutate(p.value = format.pval(p.value,digits = 1))

pl_ml_no_race_tbl_df <- rbind.fill(broom::tidy(gam_models$left_psill_mediastinal_lymphadenopathy_no_race_mod,
                                                     parametric = T),
                                   broom::tidy(gam_models$left_psill_mediastinal_lymphadenopathy_no_race_mod,
                                                                               parametric = F)) %>%
  select(term,estimate,std.error,p.value,edf,ref.df) %>%
  mutate(p.value = format.pval(p.value,digits = 1),
         term = c(terms_without_race,"s(Slice):ML"))

pr_ml_no_race_tbl_df <- rbind.fill(broom::tidy(gam_models$right_psill_mediastinal_lymphadenopathy_no_race_mod,
                                                     parametric = T),
                                   broom::tidy(gam_models$right_psill_mediastinal_lymphadenopathy_no_race_mod,
                                                                                 parametric = F)) %>%
  select(estimate,std.error,p.value,edf,ref.df) %>%
  mutate(p.value = format.pval(p.value,digits = 1))

rl_ml_race_tbl_df <- rbind.fill(broom::tidy(gam_models$left_range_mediastinal_lymphadenopathy_race_mod,
                                                  parametric = T),
                                broom::tidy(gam_models$left_range_mediastinal_lymphadenopathy_race_mod,
                                                                              parametric = F)) %>%
  select(term,estimate,std.error,p.value,edf,ref.df) %>%
  mutate(p.value = format.pval(p.value,digits = 1),
         term = c(terms_with_race,"s(Slice):ML"))

rr_ml_race_tbl_df <- rbind.fill(broom::tidy(gam_models$right_range_mediastinal_lymphadenopathy_race_mod,
                                                  parametric = T),
                                broom::tidy(gam_models$right_range_mediastinal_lymphadenopathy_race_mod,
                                                                              parametric = F)) %>%
  select(estimate,std.error,p.value,edf,ref.df) %>%
  mutate(p.value = format.pval(p.value,digits = 1))

rl_ml_no_race_tbl_df <- rbind.fill(broom::tidy(gam_models$left_range_mediastinal_lymphadenopathy_no_race_mod,
                                                     parametric = T),
                                   broom::tidy(gam_models$left_range_mediastinal_lymphadenopathy_no_race_mod,
                                                                                parametric = F)) %>%
  select(term,estimate,std.error,p.value,edf,ref.df) %>%
  mutate(p.value = format.pval(p.value,digits = 1),
         term = c(terms_without_race,"s(Slice):ML")) 

rr_ml_no_race_tbl_df <- rbind.fill(broom::tidy(gam_models$right_range_mediastinal_lymphadenopathy_no_race_mod,
                                                     parametric = T),
                                   broom::tidy(gam_models$right_range_mediastinal_lymphadenopathy_no_race_mod,
                                                                                 parametric = F)) %>%
  select(estimate,std.error,p.value,edf,ref.df) %>%
  mutate(p.value = format.pval(p.value,digits = 1))

ml_results_df <- rbind(cbind(pl_ml_race_tbl_df,pr_ml_race_tbl_df),
                             cbind(pl_ml_no_race_tbl_df,pr_ml_no_race_tbl_df),
                             cbind(rl_ml_race_tbl_df,rr_ml_race_tbl_df),
                             cbind(rl_ml_no_race_tbl_df,rr_ml_no_race_tbl_df))

ml_results_table <- kbl(ml_results_df,align = "rcccccc",digits = 4,
                              longtable = TRUE, booktabs = TRUE,
                              col.names = c("Term",rep(c("Estimate","SE","P-Value",
                                                         "EDF","Ref. DF"),2)),
                              caption = "Summary of Models for Mediastinal Lymphadenopathy (ML)") %>%
  kable_styling(full_width = FALSE, latex_options = c("HOLD_position","repeat_header"),font_size = 7) %>%
  add_header_above(c(" ","Left Lung" = 5,"Right Lung" = 5),bold = TRUE) %>%
  pack_rows("Outcome: Psill | With Race",1,10) %>%
  pack_rows("Outcome: Psill | Without Race",11,18) %>%
  pack_rows("Outcome: Range | With Race",19,28) %>%
  pack_rows("Outcome: Range | Without Race",29,36) %>%
  row_spec(0, bold = TRUE) %>%
  column_spec(2:11, width = "3.5em")

```

```{r print_med_table, echo = F}

# Mediastinal Lymphadenopathy table. 
ml_results_table

```
\doublespacing
The table above illustrates differences between models including and excluding race when mediastinal lymphadenopathy is the main clinical predictor. In all models the interaction between normalized slice and mediastinal lymphadenopathy is a significant predictor for range and psill values regardless of whether or not race was included as a predictor. For psill non-Hispanic white is a significant predictor for both lungs while the other race group is not. For range neither non-Hispanic white nor the other race group were significant predictors for either lung. 

\singlespacing
```{r med_lymph_plots, echo = F}

# Plotting left lung psill Mediastinal Lymphadenopathy model with race.
pl_med_lym_race_pred_df <- expand.grid(BMI = bmi_mean,Age = age_mean,
                                        Height = height_mean, 
                                        Gender = gender_select,
                                        Race = race_select,
                                        slice_normalized = slice_normalized_vec,
                                        Med_Lymphadenopathy = c(0,1),ID = ID_pred)

pl_med_lym_race_pred <- predict(gam_models$left_psill_mediastinal_lymphadenopathy_race_mod,
                                 newdata = pl_med_lym_race_pred_df,
                                 type = "response", exclude = "s(ID)",
                                 se.fit = TRUE)

pl_med_lym_race_df <- data.frame(pl_med_lym_race_pred_df,
                                  "Yhat" = pl_med_lym_race_pred$fit,
                                  "LB" = pl_med_lym_race_pred$fit -
                                    qnorm(0.975)*pl_med_lym_race_pred$se.fit,
                                  "UB" = pl_med_lym_race_pred$fit +
                                    qnorm(0.975)*pl_med_lym_race_pred$se.fit)

pl_med_lym_race_plot <- ggplot(pl_med_lym_race_df, 
                                aes(x = slice_normalized,
                                    y = Yhat,
                                    color = factor(Med_Lymphadenopathy))) +
  geom_line() +
  geom_ribbon(aes(ymin = LB,ymax = UB,fill = factor(Med_Lymphadenopathy)),alpha = 0.1,
              linetype = "dotted") +
  labs(y = "Predicted log(Psill)",x = "",
       title = "Left Psill ML - With Race") +
  scale_fill_discrete(name = "ML",labels = c("No","Yes")) +
  guides(color = F) +
  theme_bw() +
  theme(axis.ticks.x = element_blank(),axis.text.x = element_blank()) 

# Plotting right lung psill Mediastinal Lymphadenopathy model with race.
pr_med_lym_race_pred_df <- expand.grid(BMI = bmi_mean,Age = age_mean,
                                        Height = height_mean, 
                                        Gender = gender_select,
                                        Race = race_select,
                                        slice_normalized = slice_normalized_vec,
                                        Med_Lymphadenopathy = c(0,1),ID = ID_pred)

pr_med_lym_race_pred <- predict(gam_models$right_psill_mediastinal_lymphadenopathy_race_mod,
                                 newdata = pr_med_lym_race_pred_df,
                                 type = "response", exclude = "s(ID)",
                                 se.fit = TRUE)

pr_med_lym_race_df <- data.frame(pr_med_lym_race_pred_df,
                                  "Yhat" = pr_med_lym_race_pred$fit,
                                  "LB" = pr_med_lym_race_pred$fit -
                                    qnorm(0.975)*pr_med_lym_race_pred$se.fit,
                                  "UB" = pr_med_lym_race_pred$fit +
                                    qnorm(0.975)*pr_med_lym_race_pred$se.fit)

pr_med_lym_race_plot <- ggplot(pr_med_lym_race_df, 
                                aes(x = slice_normalized,
                                    y = Yhat,
                                    color = factor(Med_Lymphadenopathy))) +
  geom_line() +
  geom_ribbon(aes(ymin = LB,ymax = UB,fill = factor(Med_Lymphadenopathy)),alpha = 0.1,
              linetype = "dotted") +
  labs(y = "Predicted log(Psill)",x = "",
       title = "Right Psill ML - With Race") +
  scale_fill_discrete(name = "ML",labels = c("No","Yes")) +
  guides(color = F) +
  theme_bw() +
  theme(axis.ticks.x = element_blank(),axis.text.x = element_blank())

# Plotting left lung psill Mediastinal Lymphadenopathy model with no race.
pl_med_lym_no_race_pred_df <- expand.grid(BMI = bmi_mean,Age = age_mean,
                                        Height = height_mean, 
                                        Gender = gender_select,
                                        slice_normalized = slice_normalized_vec,
                                        Med_Lymphadenopathy = c(0,1),ID = ID_pred)

pl_med_lym_no_race_pred <- predict(gam_models$left_psill_mediastinal_lymphadenopathy_no_race_mod,
                                 newdata = pl_med_lym_no_race_pred_df,
                                 type = "response", exclude = "s(ID)",
                                 se.fit = TRUE)

pl_med_lym_no_race_df <- data.frame(pl_med_lym_no_race_pred_df,
                                  "Yhat" = pl_med_lym_no_race_pred$fit,
                                  "LB" = pl_med_lym_no_race_pred$fit -
                                    qnorm(0.975)*pl_med_lym_no_race_pred$se.fit,
                                  "UB" = pl_med_lym_no_race_pred$fit +
                                    qnorm(0.975)*pl_med_lym_no_race_pred$se.fit)

pl_med_lym_no_race_plot <- ggplot(pl_med_lym_no_race_df, 
                                aes(x = slice_normalized,
                                    y = Yhat,
                                    color = factor(Med_Lymphadenopathy))) +
  geom_line() +
  geom_ribbon(aes(ymin = LB,ymax = UB,fill = factor(Med_Lymphadenopathy)),alpha = 0.1,
              linetype = "dotted") +
  labs(y = "Predicted log(Psill)",x = "",
       title = "Left Psill ML - No Race") +
  scale_fill_discrete(name = "ML",labels = c("No","Yes")) +
  guides(color = F) +
  theme_bw() +
  theme(axis.ticks.x = element_blank(),axis.text.x = element_blank()) 

# Plotting right lung psill Mediastinal Lymphadenopathy model with no race.
pr_med_lym_no_race_pred_df <- expand.grid(BMI = bmi_mean,Age = age_mean,
                                        Height = height_mean, 
                                        Gender = gender_select,
                                        slice_normalized = slice_normalized_vec,
                                        Med_Lymphadenopathy = c(0,1),ID = ID_pred)

pr_med_lym_no_race_pred <- predict(gam_models$right_psill_mediastinal_lymphadenopathy_no_race_mod,
                                 newdata = pr_med_lym_no_race_pred_df,
                                 type = "response", exclude = "s(ID)",
                                 se.fit = TRUE)

pr_med_lym_no_race_df <- data.frame(pr_med_lym_no_race_pred_df,
                                  "Yhat" = pr_med_lym_no_race_pred$fit,
                                  "LB" = pr_med_lym_no_race_pred$fit -
                                    qnorm(0.975)*pr_med_lym_no_race_pred$se.fit,
                                  "UB" = pr_med_lym_no_race_pred$fit +
                                    qnorm(0.975)*pr_med_lym_no_race_pred$se.fit)

pr_med_lym_no_race_plot <- ggplot(pr_med_lym_no_race_df, 
                                aes(x = slice_normalized,
                                    y = Yhat,
                                    color = factor(Med_Lymphadenopathy))) +
  geom_line() +
  geom_ribbon(aes(ymin = LB,ymax = UB,fill = factor(Med_Lymphadenopathy)),alpha = 0.1,
              linetype = "dotted") +
  labs(y = "Predicted log(Psill)",x = "",
       title = "Right Psill ML - No Race") +
  scale_fill_discrete(name = "ML",labels = c("No","Yes")) +
  guides(color = F) +
  theme_bw() +
  theme(axis.ticks.x = element_blank(),axis.text.x = element_blank()) 

# Plotting left lung range Mediastinal Lymphadenopathy model with race.
rl_med_lym_race_pred_df <- expand.grid(BMI = bmi_mean,Age = age_mean,
                                        Height = height_mean, 
                                        Gender = gender_select,
                                        Race = race_select,
                                        slice_normalized = slice_normalized_vec,
                                        Med_Lymphadenopathy = c(0,1),ID = ID_pred)

rl_med_lym_race_pred <- predict(gam_models$left_range_mediastinal_lymphadenopathy_race_mod,
                                 newdata = rl_med_lym_race_pred_df,
                                 type = "response", exclude = "s(ID)",
                                 se.fit = TRUE)

rl_med_lym_race_df <- data.frame(rl_med_lym_race_pred_df,
                                  "Yhat" = rl_med_lym_race_pred$fit,
                                  "LB" = rl_med_lym_race_pred$fit -
                                    qnorm(0.975)*rl_med_lym_race_pred$se.fit,
                                  "UB" = rl_med_lym_race_pred$fit +
                                    qnorm(0.975)*rl_med_lym_race_pred$se.fit)

rl_med_lym_race_plot <- ggplot(rl_med_lym_race_df, 
                                aes(x = slice_normalized,
                                    y = Yhat,
                                    color = factor(Med_Lymphadenopathy))) +
  geom_line() +
  geom_ribbon(aes(ymin = LB,ymax = UB,fill = factor(Med_Lymphadenopathy)),alpha = 0.1,
              linetype = "dotted") +
  labs(y = "Predicted log(Range)",x = "",
       title = "Left Range ML - With Race") +
  scale_fill_discrete(name = "ML",labels = c("No","Yes")) +
  guides(color = F) +
  theme_bw() +
  theme(axis.ticks.x = element_blank(),axis.text.x = element_blank()) 

# Plotting right lung range Mediastinal Lymphadenopathy model with race.
rr_med_lym_race_pred_df <- expand.grid(BMI = bmi_mean,Age = age_mean,
                                        Height = height_mean, 
                                        Gender = gender_select,
                                        Race = race_select,
                                        slice_normalized = slice_normalized_vec,
                                        Med_Lymphadenopathy = c(0,1),ID = ID_pred)

rr_med_lym_race_pred <- predict(gam_models$right_range_mediastinal_lymphadenopathy_race_mod,
                                 newdata = rr_med_lym_race_pred_df,
                                 type = "response", exclude = "s(ID)",
                                 se.fit = TRUE)

rr_med_lym_race_df <- data.frame(rr_med_lym_race_pred_df,
                                  "Yhat" = rr_med_lym_race_pred$fit,
                                  "LB" = rr_med_lym_race_pred$fit -
                                    qnorm(0.975)*rr_med_lym_race_pred$se.fit,
                                  "UB" = rr_med_lym_race_pred$fit +
                                    qnorm(0.975)*rr_med_lym_race_pred$se.fit)

rr_med_lym_race_plot <- ggplot(rr_med_lym_race_df, 
                                aes(x = slice_normalized,
                                    y = Yhat,
                                    color = factor(Med_Lymphadenopathy))) +
  geom_line() +
  geom_ribbon(aes(ymin = LB,ymax = UB,fill = factor(Med_Lymphadenopathy)),alpha = 0.1,
              linetype = "dotted") +
  labs(y = "Predicted log(Range)",x = "",
       title = "Right Range ML - With Race") +
  scale_fill_discrete(name = "ML",labels = c("No","Yes")) +
  guides(color = F) +
  theme_bw() +
  theme(axis.ticks.x = element_blank(),axis.text.x = element_blank())

# Plotting left lung range Mediastinal Lymphadenopathy model with no race.
rl_med_lym_no_race_pred_df <- expand.grid(BMI = bmi_mean,Age = age_mean,
                                        Height = height_mean, 
                                        Gender = gender_select,
                                        slice_normalized = slice_normalized_vec,
                                        Med_Lymphadenopathy = c(0,1),ID = ID_pred)

rl_med_lym_no_race_pred <- predict(gam_models$left_range_mediastinal_lymphadenopathy_no_race_mod,
                                 newdata = rl_med_lym_no_race_pred_df,
                                 type = "response", exclude = "s(ID)",
                                 se.fit = TRUE)

rl_med_lym_no_race_df <- data.frame(rl_med_lym_no_race_pred_df,
                                  "Yhat" = rl_med_lym_no_race_pred$fit,
                                  "LB" = rl_med_lym_no_race_pred$fit -
                                    qnorm(0.975)*rl_med_lym_no_race_pred$se.fit,
                                  "UB" = rl_med_lym_no_race_pred$fit +
                                    qnorm(0.975)*rl_med_lym_no_race_pred$se.fit)

rl_med_lym_no_race_plot <- ggplot(rl_med_lym_no_race_df, 
                                aes(x = slice_normalized,
                                    y = Yhat,
                                    color = factor(Med_Lymphadenopathy))) +
  geom_line() +
  geom_ribbon(aes(ymin = LB,ymax = UB,fill = factor(Med_Lymphadenopathy)),alpha = 0.1,
              linetype = "dotted") +
  labs(y = "Predicted log(Range)",x = "Normalized Slice",
       title = "Left Range ML - No Race") +
  scale_fill_discrete(name = "ML",labels = c("No","Yes")) +
  guides(color = F) +
  theme_bw()

# Plotting right lung range Mediastinal Lymphadenopathy model with no race.
rr_med_lym_no_race_pred_df <- expand.grid(BMI = bmi_mean,Age = age_mean,
                                        Height = height_mean, 
                                        Gender = gender_select,
                                        slice_normalized = slice_normalized_vec,
                                        Med_Lymphadenopathy = c(0,1),ID = ID_pred)

rr_med_lym_no_race_pred <- predict(gam_models$right_range_mediastinal_lymphadenopathy_no_race_mod,
                                 newdata = rr_med_lym_no_race_pred_df,
                                 type = "response", exclude = "s(ID)",
                                 se.fit = TRUE)

rr_med_lym_no_race_df <- data.frame(rr_med_lym_no_race_pred_df,
                                  "Yhat" = rr_med_lym_no_race_pred$fit,
                                  "LB" = rr_med_lym_no_race_pred$fit -
                                    qnorm(0.975)*rr_med_lym_no_race_pred$se.fit,
                                  "UB" = rr_med_lym_no_race_pred$fit +
                                    qnorm(0.975)*rr_med_lym_no_race_pred$se.fit)

rr_med_lym_no_race_plot <- ggplot(rr_med_lym_no_race_df, 
                                aes(x = slice_normalized,
                                    y = Yhat,
                                    color = factor(Med_Lymphadenopathy))) +
  geom_line() +
  geom_ribbon(aes(ymin = LB,ymax = UB,fill = factor(Med_Lymphadenopathy)),alpha = 0.1,
              linetype = "dotted") +
  labs(y = "Predicted log(Range)",x = "Normalized Slice",
       title = "Right Range ML - No Race") +
  scale_fill_discrete(name = "ML",labels = c("No","Yes")) +
  guides(color = F) +
  theme_bw() 


```

```{r med_lymph_plots_print, echo = F,fig.height = 8}

# Formatting plots for mediastinal lymphadenopathy.
(pl_med_lym_race_plot + pr_med_lym_race_plot)/(pl_med_lym_no_race_plot + pr_med_lym_no_race_plot)/
  (rl_med_lym_race_plot + rr_med_lym_race_plot)/(rl_med_lym_no_race_plot + rr_med_lym_no_race_plot)

```
\doublespacing
The plots above show the trend of range and psill when moving up the lung (normalized slice) when mediastinal lymphadenopathy is the main clinical predictor. Similar to fibrosis, the trends in plots including and excluding race are nearly the same in trend, and subsequent analysis will consider plots excluding race. For psill the left lung has more overlap for those with and without mediastinal lymphadenopathy compared to the right lung, however both models have overlap in their 95\% confidence intervals. The right lung also has a more noticeable dip in the middle portion of the lung and then a subsequent rise in psill before quickly declining compared to the left lung. For range both left and right lung have significant overlap in 95\% confidence intervals between those with and without mediastinal lymphadenopathy, with those having the condition having slightly higher range values. The left lung plateaus in the middle, while the right lung shows a dip in range values. 

\singlespacing

### Traction Bronchiectasis (TB)

```{r trac_bronch_table, echo = F}

# Making tables for Traction Bronchiectasis results. 

pl_tb_race_tbl_df <- rbind.fill(broom::tidy(gam_models$left_psill_traction_bronchiectasis_race_mod,
                                       parametric = T),
                                broom::tidy(gam_models$left_psill_traction_bronchiectasis_race_mod,
                                                                   parametric = F)) %>%
  select(term,estimate,std.error,p.value,edf,ref.df) %>%
  mutate(p.value = format.pval(p.value,digits = 1),
         term = c(terms_with_race,"s(Slice):TB"))

pr_tb_race_tbl_df <- rbind.fill(broom::tidy(gam_models$right_psill_traction_bronchiectasis_race_mod,
                                                  parametric = T),
                                broom::tidy(gam_models$right_psill_traction_bronchiectasis_race_mod,
                                                                              parametric = F)) %>%
  select(estimate,std.error,p.value,edf,ref.df) %>%
  mutate(p.value = format.pval(p.value,digits = 1))

pl_tb_no_race_tbl_df <- rbind.fill(broom::tidy(gam_models$left_psill_traction_bronchiectasis_no_race_mod,
                                                     parametric = T),
                                   broom::tidy(gam_models$left_psill_traction_bronchiectasis_no_race_mod,
                                                                               parametric = F)) %>%
  select(term,estimate,std.error,p.value,edf,ref.df) %>%
  mutate(p.value = format.pval(p.value,digits = 1),
         term = c(terms_without_race,"s(Slice):TB"))

pr_tb_no_race_tbl_df <- rbind.fill(broom::tidy(gam_models$right_psill_traction_bronchiectasis_no_race_mod,
                                                     parametric = T),
                                   broom::tidy(gam_models$right_psill_traction_bronchiectasis_no_race_mod,
                                                                                 parametric = F)) %>%
  select(estimate,std.error,p.value,edf,ref.df) %>%
  mutate(p.value = format.pval(p.value,digits = 1))

rl_tb_race_tbl_df <- rbind.fill(broom::tidy(gam_models$left_range_traction_bronchiectasis_race_mod,
                                                  parametric = T),
                                broom::tidy(gam_models$left_range_traction_bronchiectasis_race_mod,
                                                                              parametric = F)) %>%
  select(term,estimate,std.error,p.value,edf,ref.df) %>%
  mutate(p.value = format.pval(p.value,digits = 1),
         term = c(terms_with_race,"s(Slice):TB"))

rr_tb_race_tbl_df <- rbind.fill(broom::tidy(gam_models$right_range_traction_bronchiectasis_race_mod,
                                                  parametric = T),
                                broom::tidy(gam_models$right_range_traction_bronchiectasis_race_mod,
                                                                              parametric = F)) %>%
  select(estimate,std.error,p.value,edf,ref.df) %>%
  mutate(p.value = format.pval(p.value,digits = 1))

rl_tb_no_race_tbl_df <- rbind.fill(broom::tidy(gam_models$left_range_traction_bronchiectasis_no_race_mod,
                                                     parametric = T),
                                   broom::tidy(gam_models$left_range_traction_bronchiectasis_no_race_mod,
                                                                                parametric = F)) %>%
  select(term,estimate,std.error,p.value,edf,ref.df) %>%
  mutate(p.value = format.pval(p.value,digits = 1),
         term = c(terms_without_race,"s(Slice):TB")) 

rr_tb_no_race_tbl_df <- rbind.fill(broom::tidy(gam_models$right_range_traction_bronchiectasis_no_race_mod,
                                                     parametric = T),
                                   broom::tidy(gam_models$right_range_traction_bronchiectasis_no_race_mod,
                                                                                 parametric = F)) %>%
  select(estimate,std.error,p.value,edf,ref.df) %>%
  mutate(p.value = format.pval(p.value,digits = 1))

tb_results_df <- rbind(cbind(pl_tb_race_tbl_df,pr_tb_race_tbl_df),
                             cbind(pl_tb_no_race_tbl_df,pr_tb_no_race_tbl_df),
                             cbind(rl_tb_race_tbl_df,rr_tb_race_tbl_df),
                             cbind(rl_tb_no_race_tbl_df,rr_tb_no_race_tbl_df))

tb_results_table <- kbl(tb_results_df,align = "rcccccc",digits = 4,
                              longtable = TRUE, booktabs = TRUE,
                              col.names = c("Term",rep(c("Estimate","SE","P-Value",
                                                         "EDF","Ref. DF"),2)),
                              caption = "Summary of Models for Traction Bronchiectasis (TB)") %>%
  kable_styling(full_width = FALSE, latex_options = c("HOLD_position","repeat_header"),
                font_size = 7) %>%
  add_header_above(c(" ","Left Lung" = 5,"Right Lung" = 5),bold = TRUE) %>%
  pack_rows("Outcome: Psill | With Race",1,10) %>%
  pack_rows("Outcome: Psill | Without Race",11,18) %>%
  pack_rows("Outcome: Range | With Race",19,28) %>%
  pack_rows("Outcome: Range | Without Race",29,36) %>%
  row_spec(0, bold = TRUE) %>%
  column_spec(2:11, width = "3.5em")

```

```{r trac_bronch_table_print, echo = F}

# Traction Bronchiectasis table results. 
tb_results_table

```
\doublespacing
The table above illustrates differences between models including and excluding race when traction bronchiectasis is the main clinical predictor. In all models the interaction between normalized slice and traction bronchiectasis is a significant predictor for range and psill regardless of including or excluding race. For psill non-Hispanic race is a significant predictor while the other race category is insignificant in both lungs. For range models neither race category was a significant predictor for either lung. 

\singlespacing
```{r trac_bronch_plot, echo = F}

# Plotting left lung psill Traction Bronchiectasis model with race.
pl_trac_bronch_race_pred_df <- expand.grid(BMI = bmi_mean,Age = age_mean,
                                        Height = height_mean, 
                                        Gender = gender_select,
                                        Race = race_select,
                                        slice_normalized = slice_normalized_vec,
                                        Traction_Bronchiectasis = c(0,1),ID = ID_pred)

pl_trac_bronch_race_pred <- predict(gam_models$left_psill_traction_bronchiectasis_race_mod,
                                 newdata = pl_trac_bronch_race_pred_df,
                                 type = "response", exclude = "s(ID)",
                                 se.fit = TRUE)

pl_trac_bronch_race_df <- data.frame(pl_trac_bronch_race_pred_df,
                                  "Yhat" = pl_trac_bronch_race_pred$fit,
                                  "LB" = pl_trac_bronch_race_pred$fit -
                                    qnorm(0.975)*pl_trac_bronch_race_pred$se.fit,
                                  "UB" = pl_trac_bronch_race_pred$fit +
                                    qnorm(0.975)*pl_trac_bronch_race_pred$se.fit)

pl_trac_bronch_race_plot <- ggplot(pl_trac_bronch_race_df, 
                                aes(x = slice_normalized,
                                    y = Yhat,
                                    color = factor(Traction_Bronchiectasis))) +
  geom_line() +
  geom_ribbon(aes(ymin = LB,ymax = UB,fill = factor(Traction_Bronchiectasis)),alpha = 0.1,
              linetype = "dotted") +
  labs(y = "Predicted log(Psill)",x = "",
       title = "Left Psill TB - With Race") +
  scale_fill_discrete(name = "TB",labels = c("No","Yes")) +
  guides(color = F) +
  theme_bw() +
  theme(axis.ticks.x = element_blank(),axis.text.x = element_blank())

# Plotting right lung psill Traction Bronchiectasis model with race.
pr_trac_bronch_race_pred_df <- expand.grid(BMI = bmi_mean,Age = age_mean,
                                        Height = height_mean, 
                                        Gender = gender_select,
                                        Race = race_select,
                                        slice_normalized = slice_normalized_vec,
                                        Traction_Bronchiectasis = c(0,1),ID = ID_pred)

pr_trac_bronch_race_pred <- predict(gam_models$right_psill_traction_bronchiectasis_race_mod,
                                 newdata = pr_trac_bronch_race_pred_df,
                                 type = "response", exclude = "s(ID)",
                                 se.fit = TRUE)

pr_trac_bronch_race_df <- data.frame(pr_trac_bronch_race_pred_df,
                                  "Yhat" = pr_trac_bronch_race_pred$fit,
                                  "LB" = pr_trac_bronch_race_pred$fit -
                                    qnorm(0.975)*pr_trac_bronch_race_pred$se.fit,
                                  "UB" = pr_trac_bronch_race_pred$fit +
                                    qnorm(0.975)*pr_trac_bronch_race_pred$se.fit)

pr_trac_bronch_race_plot <- ggplot(pr_trac_bronch_race_df, 
                                aes(x = slice_normalized,
                                    y = Yhat,
                                    color = factor(Traction_Bronchiectasis))) +
  geom_line() +
  geom_ribbon(aes(ymin = LB,ymax = UB,fill = factor(Traction_Bronchiectasis)),alpha = 0.1,
              linetype = "dotted") +
  labs(y = "Predicted log(Psill)",x = "",
       title = "Right Psill TB - With Race") +
  scale_fill_discrete(name = "TB",labels = c("No","Yes")) +
  guides(color = F) +
  theme_bw() +
  theme(axis.ticks.x = element_blank(),axis.text.x = element_blank())

# Plotting left lung psill Traction Bronchiectasis model no race.
pl_trac_bronch_no_race_pred_df <- expand.grid(BMI = bmi_mean,Age = age_mean,
                                        Height = height_mean, 
                                        Gender = gender_select,
                                        slice_normalized = slice_normalized_vec,
                                        Traction_Bronchiectasis = c(0,1),ID = ID_pred)

pl_trac_bronch_no_race_pred <- predict(gam_models$left_psill_traction_bronchiectasis_no_race_mod,
                                 newdata = pl_trac_bronch_no_race_pred_df,
                                 type = "response", exclude = "s(ID)",
                                 se.fit = TRUE)

pl_trac_bronch_no_race_df <- data.frame(pl_trac_bronch_no_race_pred_df,
                                  "Yhat" = pl_trac_bronch_no_race_pred$fit,
                                  "LB" = pl_trac_bronch_no_race_pred$fit -
                                    qnorm(0.975)*pl_trac_bronch_no_race_pred$se.fit,
                                  "UB" = pl_trac_bronch_no_race_pred$fit +
                                    qnorm(0.975)*pl_trac_bronch_no_race_pred$se.fit)

pl_trac_bronch_no_race_plot <- ggplot(pl_trac_bronch_no_race_df, 
                                aes(x = slice_normalized,
                                    y = Yhat,
                                    color = factor(Traction_Bronchiectasis))) +
  geom_line() +
  geom_ribbon(aes(ymin = LB,ymax = UB,fill = factor(Traction_Bronchiectasis)),alpha = 0.1,
              linetype = "dotted") +
  labs(y = "Predicted log(Psill)",x = "",
       title = "Left Psill TB - No Race") +
  scale_fill_discrete(name = "TB",labels = c("No","Yes")) +
  guides(color = F) +
  theme_bw() +
  theme(axis.ticks.x = element_blank(),axis.text.x = element_blank())

# Plotting right lung psill Traction Bronchiectasis model no race.
pr_trac_bronch_no_race_pred_df <- expand.grid(BMI = bmi_mean,Age = age_mean,
                                        Height = height_mean, 
                                        Gender = gender_select,
                                        slice_normalized = slice_normalized_vec,
                                        Traction_Bronchiectasis = c(0,1),ID = ID_pred)

pr_trac_bronch_no_race_pred <- predict(gam_models$right_psill_traction_bronchiectasis_no_race_mod,
                                 newdata = pr_trac_bronch_no_race_pred_df,
                                 type = "response", exclude = "s(ID)",
                                 se.fit = TRUE)

pr_trac_bronch_no_race_df <- data.frame(pr_trac_bronch_no_race_pred_df,
                                  "Yhat" = pr_trac_bronch_no_race_pred$fit,
                                  "LB" = pr_trac_bronch_no_race_pred$fit -
                                    qnorm(0.975)*pr_trac_bronch_no_race_pred$se.fit,
                                  "UB" = pr_trac_bronch_no_race_pred$fit +
                                    qnorm(0.975)*pr_trac_bronch_no_race_pred$se.fit)

pr_trac_bronch_no_race_plot <- ggplot(pr_trac_bronch_no_race_df, 
                                aes(x = slice_normalized,
                                    y = Yhat,
                                    color = factor(Traction_Bronchiectasis))) +
  geom_line() +
  geom_ribbon(aes(ymin = LB,ymax = UB,fill = factor(Traction_Bronchiectasis)),alpha = 0.1,
              linetype = "dotted") +
  labs(y = "Predicted log(Psill)",x = "",
       title = "Right Psill TB - No Race") +
  scale_fill_discrete(name = "TB",labels = c("No","Yes")) +
  guides(color = F) +
  theme_bw() +
  theme(axis.ticks.x = element_blank(),axis.text.x = element_blank())

# Plotting left lung range Traction Bronchiectasis model with race.
rl_trac_bronch_race_pred_df <- expand.grid(BMI = bmi_mean,Age = age_mean,
                                        Height = height_mean, 
                                        Gender = gender_select,
                                        Race = race_select,
                                        slice_normalized = slice_normalized_vec,
                                        Traction_Bronchiectasis = c(0,1),ID = ID_pred)

rl_trac_bronch_race_pred <- predict(gam_models$left_range_traction_bronchiectasis_race_mod,
                                 newdata = rl_trac_bronch_race_pred_df,
                                 type = "response", exclude = "s(ID)",
                                 se.fit = TRUE)

rl_trac_bronch_race_df <- data.frame(rl_trac_bronch_race_pred_df,
                                  "Yhat" = rl_trac_bronch_race_pred$fit,
                                  "LB" = rl_trac_bronch_race_pred$fit -
                                    qnorm(0.975)*rl_trac_bronch_race_pred$se.fit,
                                  "UB" = rl_trac_bronch_race_pred$fit +
                                    qnorm(0.975)*rl_trac_bronch_race_pred$se.fit)

rl_trac_bronch_race_plot <- ggplot(rl_trac_bronch_race_df, 
                                aes(x = slice_normalized,
                                    y = Yhat,
                                    color = factor(Traction_Bronchiectasis))) +
  geom_line() +
  geom_ribbon(aes(ymin = LB,ymax = UB,fill = factor(Traction_Bronchiectasis)),alpha = 0.1,
              linetype = "dotted") +
  labs(y = "Predicted log(Range)",x = "",
       title = "Left Range TB - With Race") +
  scale_fill_discrete(name = "TB",labels = c("No","Yes")) +
  guides(color = F) +
  theme_bw() +
  theme(axis.ticks.x = element_blank(),axis.text.x = element_blank())

# Plotting right lung range Traction Bronchiectasis model with race.
rr_trac_bronch_race_pred_df <- expand.grid(BMI = bmi_mean,Age = age_mean,
                                        Height = height_mean, 
                                        Gender = gender_select,
                                        Race = race_select,
                                        slice_normalized = slice_normalized_vec,
                                        Traction_Bronchiectasis = c(0,1),ID = ID_pred)

rr_trac_bronch_race_pred <- predict(gam_models$right_range_traction_bronchiectasis_race_mod,
                                 newdata = rr_trac_bronch_race_pred_df,
                                 type = "response", exclude = "s(ID)",
                                 se.fit = TRUE)

rr_trac_bronch_race_df <- data.frame(rr_trac_bronch_race_pred_df,
                                  "Yhat" = rr_trac_bronch_race_pred$fit,
                                  "LB" = rr_trac_bronch_race_pred$fit -
                                    qnorm(0.975)*rr_trac_bronch_race_pred$se.fit,
                                  "UB" = rr_trac_bronch_race_pred$fit +
                                    qnorm(0.975)*rr_trac_bronch_race_pred$se.fit)

rr_trac_bronch_race_plot <- ggplot(rr_trac_bronch_race_df, 
                                aes(x = slice_normalized,
                                    y = Yhat,
                                    color = factor(Traction_Bronchiectasis))) +
  geom_line() +
  geom_ribbon(aes(ymin = LB,ymax = UB,fill = factor(Traction_Bronchiectasis)),alpha = 0.1,
              linetype = "dotted") +
  labs(y = "Predicted log(Range)",x = "",
       title = "Right Range TB - With Race") +
  scale_fill_discrete(name = "TB",labels = c("No","Yes")) +
  guides(color = F) +
  theme_bw() +
  theme(axis.ticks.x = element_blank(),axis.text.x = element_blank())

# Plotting left lung range Traction Bronchiectasis model no race.
rl_trac_bronch_no_race_pred_df <- expand.grid(BMI = bmi_mean,Age = age_mean,
                                        Height = height_mean, 
                                        Gender = gender_select,
                                        slice_normalized = slice_normalized_vec,
                                        Traction_Bronchiectasis = c(0,1),ID = ID_pred)

rl_trac_bronch_no_race_pred <- predict(gam_models$left_range_traction_bronchiectasis_no_race_mod,
                                 newdata = rl_trac_bronch_no_race_pred_df,
                                 type = "response", exclude = "s(ID)",
                                 se.fit = TRUE)

rl_trac_bronch_no_race_df <- data.frame(rl_trac_bronch_no_race_pred_df,
                                  "Yhat" = rl_trac_bronch_no_race_pred$fit,
                                  "LB" = rl_trac_bronch_no_race_pred$fit -
                                    qnorm(0.975)*rl_trac_bronch_no_race_pred$se.fit,
                                  "UB" = rl_trac_bronch_no_race_pred$fit +
                                    qnorm(0.975)*rl_trac_bronch_no_race_pred$se.fit)

rl_trac_bronch_no_race_plot <- ggplot(rl_trac_bronch_no_race_df, 
                                aes(x = slice_normalized,
                                    y = Yhat,
                                    color = factor(Traction_Bronchiectasis))) +
  geom_line() +
  geom_ribbon(aes(ymin = LB,ymax = UB,fill = factor(Traction_Bronchiectasis)),alpha = 0.1,
              linetype = "dotted") +
  labs(y = "Predicted log(Range)",x = "Normalized Slice",
       title = "Left Range TB - No Race") +
  scale_fill_discrete(name = "TB",labels = c("No","Yes")) +
  guides(color = F) +
  theme_bw()

# Plotting right lung range Traction Bronchiectasis model no race.
rr_trac_bronch_no_race_pred_df <- expand.grid(BMI = bmi_mean,Age = age_mean,
                                        Height = height_mean, 
                                        Gender = gender_select,
                                        slice_normalized = slice_normalized_vec,
                                        Traction_Bronchiectasis = c(0,1),ID = ID_pred)

rr_trac_bronch_no_race_pred <- predict(gam_models$right_range_traction_bronchiectasis_no_race_mod,
                                 newdata = rr_trac_bronch_no_race_pred_df,
                                 type = "response", exclude = "s(ID)",
                                 se.fit = TRUE)

rr_trac_bronch_no_race_df <- data.frame(rr_trac_bronch_no_race_pred_df,
                                  "Yhat" = rr_trac_bronch_no_race_pred$fit,
                                  "LB" = rr_trac_bronch_no_race_pred$fit -
                                    qnorm(0.975)*rr_trac_bronch_no_race_pred$se.fit,
                                  "UB" = rr_trac_bronch_no_race_pred$fit +
                                    qnorm(0.975)*rr_trac_bronch_no_race_pred$se.fit)

rr_trac_bronch_no_race_plot <- ggplot(rr_trac_bronch_no_race_df, 
                                aes(x = slice_normalized,
                                    y = Yhat,
                                    color = factor(Traction_Bronchiectasis))) +
  geom_line() +
  geom_ribbon(aes(ymin = LB,ymax = UB,fill = factor(Traction_Bronchiectasis)),alpha = 0.1,
              linetype = "dotted") +
  labs(y = "Predicted log(Range)",x = "Normalized Slice",
       title = "Right Range TB - No Race") +
  scale_fill_discrete(name = "TB",labels = c("No","Yes")) +
  guides(color = F) +
  theme_bw()

```

```{r trac_bronch_plot_print, echo = F,fig.height= 8}

# Formation plots for Traction Bronchiectasis.
(pl_trac_bronch_race_plot + pr_trac_bronch_race_plot)/(pl_trac_bronch_no_race_plot + pr_trac_bronch_no_race_plot)/
  (rl_trac_bronch_race_plot + rr_trac_bronch_race_plot)/(rl_trac_bronch_no_race_plot + rr_trac_bronch_no_race_plot)

```
\doublespacing
The plots above show the trend of range and psill when moving up the lung (normalized slice) when traction bronchiectasis is the main clinical predictor. The trends between models including and excluding race are similar, with the psill models including race having slightly more overlap. Subsequent analysis will focus on the plots excluding race. For psill the subjects with traction bronchiectasis have higher values in both lungs compared to subjects without traction bronchiectasis. The left lung peaks in the first quarter of the lung and then decreases, while the right lung has an oscillating pattern in the middle of the lung. For range there is significant overlap in the lower portion of normalized slice for both lungs, and then a divergence, with subjects not having traction bronchiectasis having lower range values. As with psill, the right lung decreases and increases in the middle portion of the lung before steeply decreasing, while the left lung decreases after peaking before the middle portion of the lung. 

\singlespacing

### FEV1 

```{r fev1_table, echo = F}

# Making tables for Post FEV1 results. 

pl_fev1_race_tbl_df <- rbind.fill(broom::tidy(gam_models$left_psill_postfev1_race_mod,
                                       parametric = T),
                                broom::tidy(gam_models$left_psill_postfev1_race_mod,
                                                                   parametric = F)) %>%
  select(term,estimate,std.error,p.value,edf,ref.df) %>%
  mutate(p.value = format.pval(p.value,digits = 1),
         term = c(terms_with_race,"s(Slice):FEV1"))

pr_fev1_race_tbl_df <- rbind.fill(broom::tidy(gam_models$right_psill_postfev1_race_mod,
                                                  parametric = T),
                                broom::tidy(gam_models$right_psill_postfev1_race_mod,
                                                                              parametric = F)) %>%
  select(estimate,std.error,p.value,edf,ref.df) %>%
  mutate(p.value = format.pval(p.value,digits = 1))

pl_fev1_no_race_tbl_df <- rbind.fill(broom::tidy(gam_models$left_psill_postfev1_no_race_mod,
                                                     parametric = T),
                                   broom::tidy(gam_models$left_psill_postfev1_no_race_mod,
                                                                               parametric = F)) %>%
  select(term,estimate,std.error,p.value,edf,ref.df) %>%
  mutate(p.value = format.pval(p.value,digits = 1),
         term = c(terms_without_race,"s(Slice):FEV1"))

pr_fev1_no_race_tbl_df <- rbind.fill(broom::tidy(gam_models$right_psill_postfev1_no_race_mod,
                                                     parametric = T),
                                   broom::tidy(gam_models$right_psill_postfev1_no_race_mod,
                                                                                 parametric = F)) %>%
  select(estimate,std.error,p.value,edf,ref.df) %>%
  mutate(p.value = format.pval(p.value,digits = 1))

rl_fev1_race_tbl_df <- rbind.fill(broom::tidy(gam_models$left_range_postfev1_race_mod,
                                                  parametric = T),
                                broom::tidy(gam_models$left_range_postfev1_race_mod,
                                                                              parametric = F)) %>%
  select(term,estimate,std.error,p.value,edf,ref.df) %>%
  mutate(p.value = format.pval(p.value,digits = 1),
         term = c(terms_with_race,"s(Slice):FEV1"))

rr_fev1_race_tbl_df <- rbind.fill(broom::tidy(gam_models$right_range_postfev1_race_mod,
                                                  parametric = T),
                                broom::tidy(gam_models$right_range_postfev1_race_mod,
                                                                              parametric = F)) %>%
  select(estimate,std.error,p.value,edf,ref.df) %>%
  mutate(p.value = format.pval(p.value,digits = 1))

rl_fev1_no_race_tbl_df <- rbind.fill(broom::tidy(gam_models$left_range_postfev1_no_race_mod,
                                                     parametric = T),
                                   broom::tidy(gam_models$left_range_postfev1_no_race_mod,
                                                                                parametric = F)) %>%
  select(term,estimate,std.error,p.value,edf,ref.df) %>%
  mutate(p.value = format.pval(p.value,digits = 1),
         term = c(terms_without_race,"s(Slice):FEV1")) 

rr_fev1_no_race_tbl_df <- rbind.fill(broom::tidy(gam_models$right_range_postfev1_no_race_mod,
                                                     parametric = T),
                                   broom::tidy(gam_models$right_range_postfev1_no_race_mod,
                                                                                 parametric = F)) %>%
  select(estimate,std.error,p.value,edf,ref.df) %>%
  mutate(p.value = format.pval(p.value,digits = 1))

fev1_results_df <- rbind(cbind(pl_fev1_race_tbl_df,pr_fev1_race_tbl_df),
                             cbind(pl_fev1_no_race_tbl_df,pr_fev1_no_race_tbl_df),
                             cbind(rl_fev1_race_tbl_df,rr_fev1_race_tbl_df),
                             cbind(rl_fev1_no_race_tbl_df,rr_fev1_no_race_tbl_df))

fev1_results_table <- kbl(fev1_results_df,align = "rcccccc",digits = 4,
                              longtable = TRUE, booktabs = TRUE,
                              col.names = c("Term",rep(c("Estimate","SE","P-Value",
                                                         "EDF","Ref. DF"),2)),
                              caption = "Summary of Models for FEV1") %>%
  kable_styling(full_width = FALSE, latex_options = c("HOLD_position","repeat_header"),
                font_size = 7) %>%
  add_header_above(c(" ","Left Lung" = 5,"Right Lung" = 5),bold = TRUE) %>%
  pack_rows("Outcome: Psill | With Race",1,10) %>%
  pack_rows("Outcome: Psill | Without Race",11,18) %>%
  pack_rows("Outcome: Range | With Race",19,28) %>%
  pack_rows("Outcome: Range | Without Race",29,36) %>%
  row_spec(0, bold = TRUE) %>%
  column_spec(2:11, width = "3.5em")

```

```{r fev1_table_print, echo = F}

# Table of FEV1 results. 
fev1_results_table

```
\doublespacing
The table above illustrates the differences between models including and excluding race when FEV1 is the main clinical predictor. In all models the interaction between normalized slice and FEV1 is a significant predictor for range and psill regardless of including or excluding  race. For both outcomes neither race category is a significant predictor. 

\singlespacing
```{r fev1_plot, echo = F}

# Plotting left lung psill fev1 model with race.
pl_fev1_race_pred_df <- expand.grid(BMI = bmi_mean,Age = age_mean,
                                        Height = height_mean, 
                                        Gender = gender_select,
                                        Race = race_select,
                                        slice_normalized = slice_normalized_vec,
                                        POSTFEV1 = fev1_quantiles,ID = ID_pred)

pl_fev1_race_pred <- predict(gam_models$left_psill_postfev1_race_mod,
                                 newdata = pl_fev1_race_pred_df,
                                 type = "response", exclude = "s(ID)",
                                 se.fit = TRUE)

pl_fev1_race_df <- data.frame(pl_fev1_race_pred_df,
                                  "Yhat" = pl_fev1_race_pred$fit,
                                  "LB" = pl_fev1_race_pred$fit -
                                    qnorm(0.975)*pl_fev1_race_pred$se.fit,
                                  "UB" = pl_fev1_race_pred$fit +
                                    qnorm(0.975)*pl_fev1_race_pred$se.fit)

pl_fev1_race_plot <- ggplot(pl_fev1_race_df, 
                                aes(x = slice_normalized,
                                    y = Yhat,
                                    color = factor(POSTFEV1))) +
  geom_line() +
  geom_ribbon(aes(ymin = LB,ymax = UB,fill = factor(POSTFEV1)),alpha = 0.1,
              linetype = "dotted") +
  labs(y = "Predicted log(Psill)",x = "",
       title = "Left Psill FEV1 - With Race") +
  scale_fill_discrete(name = "Quantiles",labels = c("0.25","0.50","0.75")) +
  guides(color = F) +
  theme_bw() +
  theme(axis.ticks.x = element_blank(),axis.text.x = element_blank())

# Plotting right lung psill fev1 model with race.
pr_fev1_race_pred_df <- expand.grid(BMI = bmi_mean,Age = age_mean,
                                        Height = height_mean, 
                                        Gender = gender_select,
                                        Race = race_select,
                                        slice_normalized = slice_normalized_vec,
                                        POSTFEV1 = fev1_quantiles,ID = ID_pred)

pr_fev1_race_pred <- predict(gam_models$right_psill_postfev1_race_mod,
                                 newdata = pr_fev1_race_pred_df,
                                 type = "response", exclude = "s(ID)",
                                 se.fit = TRUE)

pr_fev1_race_df <- data.frame(pr_fev1_race_pred_df,
                                  "Yhat" = pr_fev1_race_pred$fit,
                                  "LB" = pr_fev1_race_pred$fit -
                                    qnorm(0.975)*pr_fev1_race_pred$se.fit,
                                  "UB" = pr_fev1_race_pred$fit +
                                    qnorm(0.975)*pr_fev1_race_pred$se.fit)

pr_fev1_race_plot <- ggplot(pr_fev1_race_df, 
                                aes(x = slice_normalized,
                                    y = Yhat,
                                    color = factor(POSTFEV1))) +
  geom_line() +
  geom_ribbon(aes(ymin = LB,ymax = UB,fill = factor(POSTFEV1)),alpha = 0.1,
              linetype = "dotted") +
  labs(y = "Predicted log(Psill)",x = "",
       title = "Right Psill FEV1 - With Race") +
  scale_fill_discrete(name = "Quantiles",labels = c("0.25","0.50","0.75")) +
  guides(color = F) +
  theme_bw() +
  theme(axis.ticks.x = element_blank(),axis.text.x = element_blank())

# Plotting left lung psill fev1 model no race.
pl_fev1_no_race_pred_df <- expand.grid(BMI = bmi_mean,Age = age_mean,
                                        Height = height_mean, 
                                        Gender = gender_select,
                                        slice_normalized = slice_normalized_vec,
                                        POSTFEV1 = fev1_quantiles,ID = ID_pred)

pl_fev1_no_race_pred <- predict(gam_models$left_psill_postfev1_no_race_mod,
                                 newdata = pl_fev1_no_race_pred_df,
                                 type = "response", exclude = "s(ID)",
                                 se.fit = TRUE)

pl_fev1_no_race_df <- data.frame(pl_fev1_no_race_pred_df,
                                  "Yhat" = pl_fev1_no_race_pred$fit,
                                  "LB" = pl_fev1_no_race_pred$fit -
                                    qnorm(0.975)*pl_fev1_no_race_pred$se.fit,
                                  "UB" = pl_fev1_no_race_pred$fit +
                                    qnorm(0.975)*pl_fev1_no_race_pred$se.fit)

pl_fev1_no_race_plot <- ggplot(pl_fev1_no_race_df, 
                                aes(x = slice_normalized,
                                    y = Yhat,
                                    color = factor(POSTFEV1))) +
  geom_line() +
  geom_ribbon(aes(ymin = LB,ymax = UB,fill = factor(POSTFEV1)),alpha = 0.1,
              linetype = "dotted") +
  labs(y = "Predicted log(Psill)",x = "",
       title = "Left Psill FEV1 - No Race") +
  scale_fill_discrete(name = "Quantiles",labels = c("0.25","0.50","0.75")) +
  guides(color = F) +
  theme_bw() +
  theme(axis.ticks.x = element_blank(),axis.text.x = element_blank())

# Plotting right lung psill fev1 model no race.
pr_fev1_no_race_pred_df <- expand.grid(BMI = bmi_mean,Age = age_mean,
                                        Height = height_mean, 
                                        Gender = gender_select,
                                        slice_normalized = slice_normalized_vec,
                                        POSTFEV1 = fev1_quantiles,ID = ID_pred)

pr_fev1_no_race_pred <- predict(gam_models$right_psill_postfev1_no_race_mod,
                                 newdata = pr_fev1_no_race_pred_df,
                                 type = "response", exclude = "s(ID)",
                                 se.fit = TRUE)

pr_fev1_no_race_df <- data.frame(pr_fev1_no_race_pred_df,
                                  "Yhat" = pr_fev1_no_race_pred$fit,
                                  "LB" = pr_fev1_no_race_pred$fit -
                                    qnorm(0.975)*pr_fev1_no_race_pred$se.fit,
                                  "UB" = pr_fev1_no_race_pred$fit +
                                    qnorm(0.975)*pr_fev1_no_race_pred$se.fit)

pr_fev1_no_race_plot <- ggplot(pr_fev1_no_race_df, 
                                aes(x = slice_normalized,
                                    y = Yhat,
                                    color = factor(POSTFEV1))) +
  geom_line() +
  geom_ribbon(aes(ymin = LB,ymax = UB,fill = factor(POSTFEV1)),alpha = 0.1,
              linetype = "dotted") +
  labs(y = "Predicted log(Psill)",x = "",
       title = "Right Psill FEV1 - No Race") +
  scale_fill_discrete(name = "Quantiles",labels = c("0.25","0.50","0.75")) +
  guides(color = F) +
  theme_bw() +
  theme(axis.ticks.x = element_blank(),axis.text.x = element_blank())

# Plotting left lung range fev1 model with race.
rl_fev1_race_pred_df <- expand.grid(BMI = bmi_mean,Age = age_mean,
                                        Height = height_mean, 
                                        Gender = gender_select,
                                        Race = race_select,
                                        slice_normalized = slice_normalized_vec,
                                        POSTFEV1 = fev1_quantiles,ID = ID_pred)

rl_fev1_race_pred <- predict(gam_models$left_range_postfev1_race_mod,
                                 newdata = rl_fev1_race_pred_df,
                                 type = "response", exclude = "s(ID)",
                                 se.fit = TRUE)

rl_fev1_race_df <- data.frame(rl_fev1_race_pred_df,
                                  "Yhat" = rl_fev1_race_pred$fit,
                                  "LB" = rl_fev1_race_pred$fit -
                                    qnorm(0.975)*rl_fev1_race_pred$se.fit,
                                  "UB" = rl_fev1_race_pred$fit +
                                    qnorm(0.975)*rl_fev1_race_pred$se.fit)

rl_fev1_race_plot <- ggplot(rl_fev1_race_df, 
                                aes(x = slice_normalized,
                                    y = Yhat,
                                    color = factor(POSTFEV1))) +
  geom_line() +
  geom_ribbon(aes(ymin = LB,ymax = UB,fill = factor(POSTFEV1)),alpha = 0.1,
              linetype = "dotted") +
  labs(y = "Predicted log(Range)",x = "",
       title = "Left Range FEV1 - With Race") +
  scale_fill_discrete(name = "Quantiles",labels = c("0.25","0.50","0.75")) +
  guides(color = F) +
  theme_bw() +
  theme(axis.ticks.x = element_blank(),axis.text.x = element_blank())

# Plotting right lung range fev1 model with race.
rr_fev1_race_pred_df <- expand.grid(BMI = bmi_mean,Age = age_mean,
                                        Height = height_mean, 
                                        Gender = gender_select,
                                        Race = race_select,
                                        slice_normalized = slice_normalized_vec,
                                        POSTFEV1 = fev1_quantiles,ID = ID_pred)

rr_fev1_race_pred <- predict(gam_models$right_range_postfev1_race_mod,
                                 newdata = rr_fev1_race_pred_df,
                                 type = "response", exclude = "s(ID)",
                                 se.fit = TRUE)

rr_fev1_race_df <- data.frame(rr_fev1_race_pred_df,
                                  "Yhat" = rr_fev1_race_pred$fit,
                                  "LB" = rr_fev1_race_pred$fit -
                                    qnorm(0.975)*rr_fev1_race_pred$se.fit,
                                  "UB" = rr_fev1_race_pred$fit +
                                    qnorm(0.975)*rr_fev1_race_pred$se.fit)

rr_fev1_race_plot <- ggplot(rr_fev1_race_df, 
                                aes(x = slice_normalized,
                                    y = Yhat,
                                    color = factor(POSTFEV1))) +
  geom_line() +
  geom_ribbon(aes(ymin = LB,ymax = UB,fill = factor(POSTFEV1)),alpha = 0.1,
              linetype = "dotted") +
  labs(y = "Predicted log(Range)",x = "",
       title = "Right Range FEV1 - With Race") +
  scale_fill_discrete(name = "Quantiles",labels = c("0.25","0.50","0.75")) +
  guides(color = F) +
  theme_bw() +
  theme(axis.ticks.x = element_blank(),axis.text.x = element_blank())

# Plotting left lung range fev1 model no race.
rl_fev1_no_race_pred_df <- expand.grid(BMI = bmi_mean,Age = age_mean,
                                        Height = height_mean, 
                                        Gender = gender_select,
                                        slice_normalized = slice_normalized_vec,
                                        POSTFEV1 = fev1_quantiles,ID = ID_pred)

rl_fev1_no_race_pred <- predict(gam_models$left_range_postfev1_no_race_mod,
                                 newdata = rl_fev1_no_race_pred_df,
                                 type = "response", exclude = "s(ID)",
                                 se.fit = TRUE)

rl_fev1_no_race_df <- data.frame(rl_fev1_no_race_pred_df,
                                  "Yhat" = rl_fev1_no_race_pred$fit,
                                  "LB" = rl_fev1_no_race_pred$fit -
                                    qnorm(0.975)*rl_fev1_no_race_pred$se.fit,
                                  "UB" = rl_fev1_no_race_pred$fit +
                                    qnorm(0.975)*rl_fev1_no_race_pred$se.fit)

rl_fev1_no_race_plot <- ggplot(rl_fev1_no_race_df, 
                                aes(x = slice_normalized,
                                    y = Yhat,
                                    color = factor(POSTFEV1))) +
  geom_line() +
  geom_ribbon(aes(ymin = LB,ymax = UB,fill = factor(POSTFEV1)),alpha = 0.1,
              linetype = "dotted") +
  labs(y = "Predicted log(Range)",x = "Normalized Slice",
       title = "Left Range FEV1 - No Race") +
  scale_fill_discrete(name = "Quantiles",labels = c("o.25","0.50","0.75")) +
  guides(color = F) +
  theme_bw()

# Plotting right lung range fev1 model no race.
rr_fev1_no_race_pred_df <- expand.grid(BMI = bmi_mean,Age = age_mean,
                                        Height = height_mean, 
                                        Gender = gender_select,
                                        slice_normalized = slice_normalized_vec,
                                        POSTFEV1 = fev1_quantiles,ID = ID_pred)

rr_fev1_no_race_pred <- predict(gam_models$right_range_postfev1_no_race_mod,
                                 newdata = rr_fev1_no_race_pred_df,
                                 type = "response", exclude = "s(ID)",
                                 se.fit = TRUE)

rr_fev1_no_race_df <- data.frame(rr_fev1_no_race_pred_df,
                                  "Yhat" = rr_fev1_no_race_pred$fit,
                                  "LB" = rr_fev1_no_race_pred$fit -
                                    qnorm(0.975)*rr_fev1_no_race_pred$se.fit,
                                  "UB" = rr_fev1_no_race_pred$fit +
                                    qnorm(0.975)*rr_fev1_no_race_pred$se.fit)

rr_fev1_no_race_plot <- ggplot(rr_fev1_no_race_df, 
                                aes(x = slice_normalized,
                                    y = Yhat,
                                    color = factor(POSTFEV1))) +
  geom_line() +
  geom_ribbon(aes(ymin = LB,ymax = UB,fill = factor(POSTFEV1)),alpha = 0.1,
              linetype = "dotted") +
  labs(y = "Predicted log(Range)",x = "Normalized Slice",
       title = "Right Range FEV1 - No Race") +
  scale_fill_discrete(name = "Quantiles",labels = c("0.25","0.50","0.75")) +
  guides(color = F) +
  theme_bw()


```

```{r fev1_plot_print, echo = F,fig.height = 8}

# Formatting plots for FEV1.
(pl_fev1_race_plot + pr_fev1_race_plot)/(pl_fev1_no_race_plot + pr_fev1_no_race_plot)/
  (rl_fev1_race_plot + rr_fev1_race_plot)/(rl_fev1_no_race_plot + rr_fev1_no_race_plot)

```
\doublespacing
The plots above show the trend of range and psill when moving up the lung (normalized slice) when FEV1 is the main clinical predictor. Models including race have slightly more overlap compared to models excluding race. Subsequent analysis will consider plots excluding race. For both range and psill higher FEV1 values are associated with lower predicted outcomes. For left lung psill there is a peak in the first half of the lung, and a general decreasing trend when moving up the lung.l For right lung psill there is a noticeable dip around the center of the lung. For range the left lung has a plateau in the middle of the plot before decreasing when moving up the lung, and the right lung has a dip near the center before rising slightly and then dropping off sharply when moving up the lung. 

\singlespacing
### FVC

```{r fvc_table, echo = F}

# Making tables for post FVC results. 

pl_fvc_race_tbl_df <- rbind.fill(broom::tidy(gam_models$left_psill_postfvc_race_mod,
                                       parametric = T),
                                broom::tidy(gam_models$left_psill_postfvc_race_mod,
                                                                   parametric = F)) %>%
  select(term,estimate,std.error,p.value,edf,ref.df) %>%
  mutate(p.value = format.pval(p.value,digits = 1),
         term = c(terms_with_race,"s(Slice):FVC"))

pr_fvc_race_tbl_df <- rbind.fill(broom::tidy(gam_models$right_psill_postfvc_race_mod,
                                                  parametric = T),
                                broom::tidy(gam_models$right_psill_postfvc_race_mod,
                                                                              parametric = F)) %>%
  select(estimate,std.error,p.value,edf,ref.df) %>%
  mutate(p.value = format.pval(p.value,digits = 1))

pl_fvc_no_race_tbl_df <- rbind.fill(broom::tidy(gam_models$left_psill_postfvc_no_race_mod,
                                                     parametric = T),
                                   broom::tidy(gam_models$left_psill_postfvc_no_race_mod,
                                                                               parametric = F)) %>%
  select(term,estimate,std.error,p.value,edf,ref.df) %>%
  mutate(p.value = format.pval(p.value,digits = 1),
         term = c(terms_without_race,"s(Slice):FVC"))

pr_fvc_no_race_tbl_df <- rbind.fill(broom::tidy(gam_models$right_psill_postfvc_no_race_mod,
                                                     parametric = T),
                                   broom::tidy(gam_models$right_psill_postfvc_no_race_mod,
                                                                                 parametric = F)) %>%
  select(estimate,std.error,p.value,edf,ref.df) %>%
  mutate(p.value = format.pval(p.value,digits = 1))

rl_fvc_race_tbl_df <- rbind.fill(broom::tidy(gam_models$left_range_postfvc_race_mod,
                                                  parametric = T),
                                broom::tidy(gam_models$left_range_postfvc_race_mod,
                                                                              parametric = F)) %>%
  select(term,estimate,std.error,p.value,edf,ref.df) %>%
  mutate(p.value = format.pval(p.value,digits = 1),
         term = c(terms_with_race,"s(Slice):FVC"))

rr_fvc_race_tbl_df <- rbind.fill(broom::tidy(gam_models$right_range_postfvc_race_mod,
                                                  parametric = T),
                                broom::tidy(gam_models$right_range_postfvc_race_mod,
                                                                              parametric = F)) %>%
  select(estimate,std.error,p.value,edf,ref.df) %>%
  mutate(p.value = format.pval(p.value,digits = 1))

rl_fvc_no_race_tbl_df <- rbind.fill(broom::tidy(gam_models$left_range_postfvc_no_race_mod,
                                                     parametric = T),
                                   broom::tidy(gam_models$left_range_postfvc_no_race_mod,
                                                                                parametric = F)) %>%
  select(term,estimate,std.error,p.value,edf,ref.df) %>%
  mutate(p.value = format.pval(p.value,digits = 1),
         term = c(terms_without_race,"s(Slice):FVC")) 

rr_fvc_no_race_tbl_df <- rbind.fill(broom::tidy(gam_models$right_range_postfvc_no_race_mod,
                                                     parametric = T),
                                   broom::tidy(gam_models$right_range_postfvc_no_race_mod,
                                                                                 parametric = F)) %>%
  select(estimate,std.error,p.value,edf,ref.df) %>%
  mutate(p.value = format.pval(p.value,digits = 1))

fvc_results_df <- rbind(cbind(pl_fvc_race_tbl_df,pr_fvc_race_tbl_df),
                             cbind(pl_fvc_no_race_tbl_df,pr_fvc_no_race_tbl_df),
                             cbind(rl_fvc_race_tbl_df,rr_fvc_race_tbl_df),
                             cbind(rl_fvc_no_race_tbl_df,rr_fvc_no_race_tbl_df))

fvc_results_table <- kbl(fvc_results_df,align = "rcccccc",digits = 4,
                              longtable = TRUE, booktabs = TRUE,
                              col.names = c("Term",rep(c("Estimate","SE","P-Value",
                                                         "EDF","Ref. DF"),2)),
                              caption = "Summary of Models for FVC") %>%
  kable_styling(full_width = FALSE, latex_options = c("HOLD_position","repeat_header"),
                font_size = 7) %>%
  add_header_above(c(" ","Left Lung" = 5,"Right Lung" = 5),bold = TRUE) %>%
  pack_rows("Outcome: Psill | With Race",1,10) %>%
  pack_rows("Outcome: Psill | Without Race",11,18) %>%
  pack_rows("Outcome: Range | With Race",19,28) %>%
  pack_rows("Outcome: Range | Without Race",29,36) %>%
  row_spec(0, bold = TRUE) %>%
  column_spec(2:11, width = "3.5em")

```

```{r fvc_table_print, echo = F}

# Table of post FVC results. 
fvc_results_table

```
\doublespacing
The table above illustrates the differences between models including and excluding race when FVC is the main clinical predictor. In all models the interaction between normalized slice and FVC is a significant predictor for range and psill regardless of whether race is included or excluded. Race is an insignificant predictor in both lungs for both outcomes. 

\singlespacing
```{r fvc_plot, echo = F}

# Plotting left lung psill fvc model with race.
pl_fvc_race_pred_df <- expand.grid(BMI = bmi_mean,Age = age_mean,
                                        Height = height_mean, 
                                        Gender = gender_select,
                                        Race = race_select,
                                        slice_normalized = slice_normalized_vec,
                                        POSTFVC = fvc_quantiles,ID = ID_pred)

pl_fvc_race_pred <- predict(gam_models$left_psill_postfvc_race_mod,
                                 newdata = pl_fvc_race_pred_df,
                                 type = "response", exclude = "s(ID)",
                                 se.fit = TRUE)

pl_fvc_race_df <- data.frame(pl_fvc_race_pred_df,
                                  "Yhat" = pl_fvc_race_pred$fit,
                                  "LB" = pl_fvc_race_pred$fit -
                                    qnorm(0.975)*pl_fvc_race_pred$se.fit,
                                  "UB" = pl_fvc_race_pred$fit +
                                    qnorm(0.975)*pl_fvc_race_pred$se.fit)

pl_fvc_race_plot <- ggplot(pl_fvc_race_df, 
                                aes(x = slice_normalized,
                                    y = Yhat,
                                    color = factor(POSTFVC))) +
  geom_line() +
  geom_ribbon(aes(ymin = LB,ymax = UB,fill = factor(POSTFVC)),alpha = 0.1,
              linetype = "dotted") +
  labs(y = "Predicted log(Psill)",x = "",
       title = "Left Psill FVC - With Race") +
  scale_fill_discrete(name = "Quantiles",labels = c("0.25","0.50","0.75")) +
  guides(color = F) +
  theme_bw() +
  theme(axis.ticks.x = element_blank(),axis.text.x = element_blank())

# Plotting right lung psill fvc model with race.
pr_fvc_race_pred_df <- expand.grid(BMI = bmi_mean,Age = age_mean,
                                        Height = height_mean, 
                                        Gender = gender_select,
                                        Race = race_select,
                                        slice_normalized = slice_normalized_vec,
                                        POSTFVC = fvc_quantiles,ID = ID_pred)

pr_fvc_race_pred <- predict(gam_models$right_psill_postfvc_race_mod,
                                 newdata = pr_fvc_race_pred_df,
                                 type = "response", exclude = "s(ID)",
                                 se.fit = TRUE)

pr_fvc_race_df <- data.frame(pr_fvc_race_pred_df,
                                  "Yhat" = pr_fvc_race_pred$fit,
                                  "LB" = pr_fvc_race_pred$fit -
                                    qnorm(0.975)*pr_fvc_race_pred$se.fit,
                                  "UB" = pr_fvc_race_pred$fit +
                                    qnorm(0.975)*pr_fvc_race_pred$se.fit)

pr_fvc_race_plot <- ggplot(pr_fvc_race_df, 
                                aes(x = slice_normalized,
                                    y = Yhat,
                                    color = factor(POSTFVC))) +
  geom_line() +
  geom_ribbon(aes(ymin = LB,ymax = UB,fill = factor(POSTFVC)),alpha = 0.1,
              linetype = "dotted") +
  labs(y = "Predicted log(Psill)",x = "",
       title = "Right Psill FVC - With Race") +
  scale_fill_discrete(name = "Quantiles",labels = c("0.25","0.50","0.75")) +
  guides(color = F) +
  theme_bw() +
  theme(axis.ticks.x = element_blank(),axis.text.x = element_blank())

# Plotting left lung psill fvc model no race.
pl_fvc_no_race_pred_df <- expand.grid(BMI = bmi_mean,Age = age_mean,
                                        Height = height_mean, 
                                        Gender = gender_select,
                                        slice_normalized = slice_normalized_vec,
                                        POSTFVC = fvc_quantiles,ID = ID_pred)

pl_fvc_no_race_pred <- predict(gam_models$left_psill_postfvc_no_race_mod,
                                 newdata = pl_fvc_no_race_pred_df,
                                 type = "response", exclude = "s(ID)",
                                 se.fit = TRUE)

pl_fvc_no_race_df <- data.frame(pl_fvc_no_race_pred_df,
                                  "Yhat" = pl_fvc_no_race_pred$fit,
                                  "LB" = pl_fvc_no_race_pred$fit -
                                    qnorm(0.975)*pl_fvc_no_race_pred$se.fit,
                                  "UB" = pl_fvc_no_race_pred$fit +
                                    qnorm(0.975)*pl_fvc_no_race_pred$se.fit)

pl_fvc_no_race_plot <- ggplot(pl_fvc_no_race_df, 
                                aes(x = slice_normalized,
                                    y = Yhat,
                                    color = factor(POSTFVC))) +
  geom_line() +
  geom_ribbon(aes(ymin = LB,ymax = UB,fill = factor(POSTFVC)),alpha = 0.1,
              linetype = "dotted") +
  labs(y = "Predicted log(Psill)",x = "",
       title = "Left Psill FVC - No Race") +
  scale_fill_discrete(name = "Quantiles",labels = c("0.25","0.50","0.75")) +
  guides(color = F) +
  theme_bw() +
  theme(axis.ticks.x = element_blank(),axis.text.x = element_blank()) 

# Plotting right lung psill fvc model no race.
pr_fvc_no_race_pred_df <- expand.grid(BMI = bmi_mean,Age = age_mean,
                                        Height = height_mean, 
                                        Gender = gender_select,
                                        slice_normalized = slice_normalized_vec,
                                        POSTFVC = fvc_quantiles,ID = ID_pred)

pr_fvc_no_race_pred <- predict(gam_models$right_psill_postfvc_no_race_mod,
                                 newdata = pr_fvc_no_race_pred_df,
                                 type = "response", exclude = "s(ID)",
                                 se.fit = TRUE)

pr_fvc_no_race_df <- data.frame(pr_fvc_no_race_pred_df,
                                  "Yhat" = pr_fvc_no_race_pred$fit,
                                  "LB" = pr_fvc_no_race_pred$fit -
                                    qnorm(0.975)*pr_fvc_no_race_pred$se.fit,
                                  "UB" = pr_fvc_no_race_pred$fit +
                                    qnorm(0.975)*pr_fvc_no_race_pred$se.fit)

pr_fvc_no_race_plot <- ggplot(pr_fvc_no_race_df, 
                                aes(x = slice_normalized,
                                    y = Yhat,
                                    color = factor(POSTFVC))) +
  geom_line() +
  geom_ribbon(aes(ymin = LB,ymax = UB,fill = factor(POSTFVC)),alpha = 0.1,
              linetype = "dotted") +
  labs(y = "Predicted log(Psill)",x = "",
       title = "Right Psill FVC - No Race") +
  scale_fill_discrete(name = "Quantiles",labels = c("0.25","0.50","0.75")) +
  guides(color = F) +
  theme_bw() +
  theme(axis.ticks.x = element_blank(),axis.text.x = element_blank())

# Plotting left lung range fvc model with race.
rl_fvc_race_pred_df <- expand.grid(BMI = bmi_mean,Age = age_mean,
                                        Height = height_mean, 
                                        Gender = gender_select,
                                        Race = race_select,
                                        slice_normalized = slice_normalized_vec,
                                        POSTFVC = fvc_quantiles,ID = ID_pred)

rl_fvc_race_pred <- predict(gam_models$left_range_postfvc_race_mod,
                                 newdata = rl_fvc_race_pred_df,
                                 type = "response", exclude = "s(ID)",
                                 se.fit = TRUE)

rl_fvc_race_df <- data.frame(rl_fvc_race_pred_df,
                                  "Yhat" = rl_fvc_race_pred$fit,
                                  "LB" = rl_fvc_race_pred$fit -
                                    qnorm(0.975)*rl_fvc_race_pred$se.fit,
                                  "UB" = rl_fvc_race_pred$fit +
                                    qnorm(0.975)*rl_fvc_race_pred$se.fit)

rl_fvc_race_plot <- ggplot(rl_fvc_race_df, 
                                aes(x = slice_normalized,
                                    y = Yhat,
                                    color = factor(POSTFVC))) +
  geom_line() +
  geom_ribbon(aes(ymin = LB,ymax = UB,fill = factor(POSTFVC)),alpha = 0.1,
              linetype = "dotted") +
  labs(y = "Predicted log(Range)",x = "",
       title = "Left Range FVC - With Race") +
  scale_fill_discrete(name = "Quantiles",labels = c("0.25","0.50","0.75")) +
  guides(color = F) +
  theme_bw() +
  theme(axis.ticks.x = element_blank(),axis.text.x = element_blank())

# Plotting right lung range fvc model with race.
rr_fvc_race_pred_df <- expand.grid(BMI = bmi_mean,Age = age_mean,
                                        Height = height_mean, 
                                        Gender = gender_select,
                                        Race = race_select,
                                        slice_normalized = slice_normalized_vec,
                                        POSTFVC = fvc_quantiles,ID = ID_pred)

rr_fvc_race_pred <- predict(gam_models$right_range_postfvc_race_mod,
                                 newdata = rr_fvc_race_pred_df,
                                 type = "response", exclude = "s(ID)",
                                 se.fit = TRUE)

rr_fvc_race_df <- data.frame(rr_fvc_race_pred_df,
                                  "Yhat" = rr_fvc_race_pred$fit,
                                  "LB" = rr_fvc_race_pred$fit -
                                    qnorm(0.975)*rr_fvc_race_pred$se.fit,
                                  "UB" = rr_fvc_race_pred$fit +
                                    qnorm(0.975)*rr_fvc_race_pred$se.fit)

rr_fvc_race_plot <- ggplot(rr_fvc_race_df, 
                                aes(x = slice_normalized,
                                    y = Yhat,
                                    color = factor(POSTFVC))) +
  geom_line() +
  geom_ribbon(aes(ymin = LB,ymax = UB,fill = factor(POSTFVC)),alpha = 0.1,
              linetype = "dotted") +
  labs(y = "Predicted log(Range)",x = "",
       title = "Right Range FVC - With Race") +
  scale_fill_discrete(name = "Quantiles",labels = c("0.25","0.50","0.75")) +
  guides(color = F) +
  theme_bw() +
  theme(axis.ticks.x = element_blank(),axis.text.x = element_blank())

# Plotting left lung range fvc model no race.
rl_fvc_no_race_pred_df <- expand.grid(BMI = bmi_mean,Age = age_mean,
                                        Height = height_mean, 
                                        Gender = gender_select,
                                        slice_normalized = slice_normalized_vec,
                                        POSTFVC = fvc_quantiles,ID = ID_pred)

rl_fvc_no_race_pred <- predict(gam_models$left_range_postfvc_no_race_mod,
                                 newdata = rl_fvc_no_race_pred_df,
                                 type = "response", exclude = "s(ID)",
                                 se.fit = TRUE)

rl_fvc_no_race_df <- data.frame(rl_fvc_no_race_pred_df,
                                  "Yhat" = rl_fvc_no_race_pred$fit,
                                  "LB" = rl_fvc_no_race_pred$fit -
                                    qnorm(0.975)*rl_fvc_no_race_pred$se.fit,
                                  "UB" = rl_fvc_no_race_pred$fit +
                                    qnorm(0.975)*rl_fvc_no_race_pred$se.fit)

rl_fvc_no_race_plot <- ggplot(rl_fvc_no_race_df, 
                                aes(x = slice_normalized,
                                    y = Yhat,
                                    color = factor(POSTFVC))) +
  geom_line() +
  geom_ribbon(aes(ymin = LB,ymax = UB,fill = factor(POSTFVC)),alpha = 0.1,
              linetype = "dotted") +
  labs(y = "Predicted log(Range)",x = "",
       title = "Left Range FVC - No Race") +
  scale_fill_discrete(name = "Quantiles",labels = c("0.25","0.50","0.75")) +
  guides(color = F) +
  theme_bw() 

# Plotting right lung range fvc model no race.
rr_fvc_no_race_pred_df <- expand.grid(BMI = bmi_mean,Age = age_mean,
                                        Height = height_mean, 
                                        Gender = gender_select,
                                        slice_normalized = slice_normalized_vec,
                                        POSTFVC = fvc_quantiles,ID = ID_pred)

rr_fvc_no_race_pred <- predict(gam_models$right_range_postfvc_no_race_mod,
                                 newdata = rr_fvc_no_race_pred_df,
                                 type = "response", exclude = "s(ID)",
                                 se.fit = TRUE)

rr_fvc_no_race_df <- data.frame(rr_fvc_no_race_pred_df,
                                  "Yhat" = rr_fvc_no_race_pred$fit,
                                  "LB" = rr_fvc_no_race_pred$fit -
                                    qnorm(0.975)*rr_fvc_no_race_pred$se.fit,
                                  "UB" = rr_fvc_no_race_pred$fit +
                                    qnorm(0.975)*rr_fvc_no_race_pred$se.fit)

rr_fvc_no_race_plot <- ggplot(rr_fvc_no_race_df, 
                                aes(x = slice_normalized,
                                    y = Yhat,
                                    color = factor(POSTFVC))) +
  geom_line() +
  geom_ribbon(aes(ymin = LB,ymax = UB,fill = factor(POSTFVC)),alpha = 0.1,
              linetype = "dotted") +
  labs(y = "Predicted log(Range)",x = "",
       title = "Right Range FVC - No Race") +
  scale_fill_discrete(name = "Quantiles",labels = c("0.25","0.50","0.75")) +
  guides(color = F) +
  theme_bw() 

```

```{r fvc_plot_print, echo = F,fig.height = 8}

# Formatting plots for FVC. 
(pl_fvc_race_plot + pr_fvc_race_plot)/(pl_fvc_no_race_plot + pr_fvc_no_race_plot)/
  (rl_fvc_race_plot + rr_fvc_race_plot)/(rl_fvc_no_race_plot + rr_fvc_no_race_plot)

```
\doublespacing
The plots above show the trend of range and psill when moving up the lung (normalized slice) when FVC is the main clinical predictor. The models excluding race have narrower 95\% confidence intervals compared to models including race. Subsequent analysis will only consider models excluding race. For both psill and range higher FVC values are associated with lower predicted outcomes. For the left lung psill there is a peak before the middle of the lung and then a decrease when moving up the lung. For the right lung there is a noticeable decrease in the middle of the lung before increasing and then subsequently decreasing sharply. For range the left lung has a plateau in the middle, while the right lung has a slight increase after the middle portion of the lung, and then a sharp decrease. 

\singlespacing
### FEV1/FVC

```{r fev1_fvc_table, echo = F}

# Making tables for post FEV1/FVC results. 

pl_fev1fvc_race_tbl_df <- rbind.fill(broom::tidy(gam_models$left_psill_postfev1fvc_race_mod,
                                       parametric = T),
                                broom::tidy(gam_models$left_psill_postfev1fvc_race_mod,
                                                                   parametric = F)) %>%
  select(term,estimate,std.error,p.value,edf,ref.df) %>%
  mutate(p.value = format.pval(p.value,digits = 1),
         term = c(terms_with_race,"s(Slice):FEV1/FVC"))

pr_fev1fvc_race_tbl_df <- rbind.fill(broom::tidy(gam_models$right_psill_postfev1fvc_race_mod,
                                                  parametric = T),
                                broom::tidy(gam_models$right_psill_postfev1fvc_race_mod,
                                                                              parametric = F)) %>%
  select(estimate,std.error,p.value,edf,ref.df) %>%
  mutate(p.value = format.pval(p.value,digits = 1))

pl_fev1fvc_no_race_tbl_df <- rbind.fill(broom::tidy(gam_models$left_psill_postfev1fvc_no_race_mod,
                                                     parametric = T),
                                   broom::tidy(gam_models$left_psill_postfev1fvc_no_race_mod,
                                                                               parametric = F)) %>%
  select(term,estimate,std.error,p.value,edf,ref.df) %>%
  mutate(p.value = format.pval(p.value,digits = 1),
         term = c(terms_without_race,"s(Slice):FEV1/FVC"))

pr_fev1fvc_no_race_tbl_df <- rbind.fill(broom::tidy(gam_models$right_psill_postfev1fvc_no_race_mod,
                                                     parametric = T),
                                   broom::tidy(gam_models$right_psill_postfev1fvc_no_race_mod,
                                                                                 parametric = F)) %>%
  select(estimate,std.error,p.value,edf,ref.df) %>%
  mutate(p.value = format.pval(p.value,digits = 1))

rl_fev1fvc_race_tbl_df <- rbind.fill(broom::tidy(gam_models$left_range_postfev1fvc_race_mod,
                                                  parametric = T),
                                broom::tidy(gam_models$left_range_postfev1fvc_race_mod,
                                                                              parametric = F)) %>%
  select(term,estimate,std.error,p.value,edf,ref.df) %>%
  mutate(p.value = format.pval(p.value,digits = 1),
         term = c(terms_with_race,"s(Slice):FEV1/FVC"))

rr_fev1fvc_race_tbl_df <- rbind.fill(broom::tidy(gam_models$right_range_postfev1fvc_race_mod,
                                                  parametric = T),
                                broom::tidy(gam_models$right_range_postfev1fvc_race_mod,
                                                                              parametric = F)) %>%
  select(estimate,std.error,p.value,edf,ref.df) %>%
  mutate(p.value = format.pval(p.value,digits = 1))

rl_fev1fvc_no_race_tbl_df <- rbind.fill(broom::tidy(gam_models$left_range_postfev1fvc_no_race_mod,
                                                     parametric = T),
                                   broom::tidy(gam_models$left_range_postfev1fvc_no_race_mod,
                                                                                parametric = F)) %>%
  select(term,estimate,std.error,p.value,edf,ref.df) %>%
  mutate(p.value = format.pval(p.value,digits = 1),
         term = c(terms_without_race,"s(Slice):FEV1/FVC")) 

rr_fev1fvc_no_race_tbl_df <- rbind.fill(broom::tidy(gam_models$right_range_postfev1fvc_no_race_mod,
                                                     parametric = T),
                                   broom::tidy(gam_models$right_range_postfev1fvc_no_race_mod,
                                                                                 parametric = F)) %>%
  select(estimate,std.error,p.value,edf,ref.df) %>%
  mutate(p.value = format.pval(p.value,digits = 1))

fev1fvc_results_df <- rbind(cbind(pl_fev1fvc_race_tbl_df,pr_fev1fvc_race_tbl_df),
                             cbind(pl_fev1fvc_no_race_tbl_df,pr_fev1fvc_no_race_tbl_df),
                             cbind(rl_fev1fvc_race_tbl_df,rr_fev1fvc_race_tbl_df),
                             cbind(rl_fev1fvc_no_race_tbl_df,rr_fev1fvc_no_race_tbl_df))

fev1fvc_results_table <- kbl(fev1fvc_results_df,align = "rcccccc",digits = 4,
                              longtable = TRUE, booktabs = TRUE,
                              col.names = c("Term",rep(c("Estimate","SE","P-Value",
                                                         "EDF","Ref. DF"),2)),
                              caption = "Summary of Models for FEV1/FVC") %>%
  kable_styling(full_width = FALSE, latex_options = c("HOLD_position","repeat_header"),
                font_size = 7) %>%
  add_header_above(c(" ","Left Lung" = 5,"Right Lung" = 5),bold = TRUE) %>%
  pack_rows("Outcome: Psill | With Race",1,10) %>%
  pack_rows("Outcome: Psill | Without Race",11,18) %>%
  pack_rows("Outcome: Range | With Race",19,28) %>%
  pack_rows("Outcome: Range | Without Race",29,36) %>%
  row_spec(0, bold = TRUE) %>%
  column_spec(2:11, width = "3.5em")

```

```{r fev1_fvc_table_print, echo = F}

fev1fvc_results_table

```
\doublespacing
The table above illustrates the differences between models including and excluding race when FEV1/FVC is the main clinical predictor. In all models the interaction between normalized slice and FEV1/FVC are significant regardless of whether race was included or excluded. For psill non-Hispanic white is significant for both lungs, while the other races category is not significant. For range neither race category is a significant predictor in either lung. 

\singlespacing
```{r fev1_fvc_plot, echo = F}

# Plotting left lung psill fev1/fvc model with race.
pl_fev1_fvc_race_pred_df <- expand.grid(BMI = bmi_mean,Age = age_mean,
                                        Height = height_mean, 
                                        Gender = gender_select,
                                        Race = race_select,
                                        slice_normalized = slice_normalized_vec,
                                        POSTFEVFVC = fev1fvc_quantiles,ID = ID_pred)

pl_fev1_fvc_race_pred <- predict(gam_models$left_psill_postfev1fvc_race_mod,
                                 newdata = pl_fev1_fvc_race_pred_df,
                                 type = "response", exclude = "s(ID)",
                                 se.fit = TRUE)

pl_fev1_fvc_race_df <- data.frame(pl_fev1_fvc_race_pred_df,
                                  "Yhat" = pl_fev1_fvc_race_pred$fit,
                                  "LB" = pl_fev1_fvc_race_pred$fit -
                                    qnorm(0.975)*pl_fev1_fvc_race_pred$se.fit,
                                  "UB" = pl_fev1_fvc_race_pred$fit +
                                    qnorm(0.975)*pl_fev1_fvc_race_pred$se.fit)

pl_fev1_fvc_race_plot <- ggplot(pl_fev1_fvc_race_df, 
                                aes(x = slice_normalized,
                                    y = Yhat,
                                    color = factor(POSTFEVFVC))) +
  geom_line() +
  geom_ribbon(aes(ymin = LB,ymax = UB,fill = factor(POSTFEVFVC)),alpha = 0.1,
              linetype = "dotted") +
  labs(y = "Predicted log(Psill)",x = "",
       title = "Left Psill FEV1/FVC - With Race") +
  scale_fill_discrete(name = "Quantiles",labels = c("0.25","0.50","0.75")) +
  guides(color = F) +
  theme_bw() +
  theme(axis.ticks.x = element_blank(),axis.text.x = element_blank())

# Plotting right lung psill fev1/fvc model with race.
pr_fev1_fvc_race_pred_df <- expand.grid(BMI = bmi_mean,Age = age_mean,
                                        Height = height_mean, 
                                        Gender = gender_select,
                                        Race = race_select,
                                        slice_normalized = slice_normalized_vec,
                                        POSTFEVFVC = fev1fvc_quantiles,ID = ID_pred)

pr_fev1_fvc_race_pred <- predict(gam_models$right_psill_postfev1fvc_race_mod,
                                 newdata = pr_fev1_fvc_race_pred_df,
                                 type = "response", exclude = "s(ID)",
                                 se.fit = TRUE)

pr_fev1_fvc_race_df <- data.frame(pr_fev1_fvc_race_pred_df,
                                  "Yhat" = pr_fev1_fvc_race_pred$fit,
                                  "LB" = pr_fev1_fvc_race_pred$fit -
                                    qnorm(0.975)*pr_fev1_fvc_race_pred$se.fit,
                                  "UB" = pr_fev1_fvc_race_pred$fit +
                                    qnorm(0.975)*pr_fev1_fvc_race_pred$se.fit)

pr_fev1_fvc_race_plot <- ggplot(pr_fev1_fvc_race_df, 
                                aes(x = slice_normalized,
                                    y = Yhat,
                                    color = factor(POSTFEVFVC))) +
  geom_line() +
  geom_ribbon(aes(ymin = LB,ymax = UB,fill = factor(POSTFEVFVC)),alpha = 0.1,
              linetype = "dotted") +
  labs(y = "Predicted log(Psill)",x = "",
       title = "Right Psill FEV1/FVC - With Race") +
  scale_fill_discrete(name = "Quantiles",labels = c("0.25","0.50","0.75")) +
  guides(color = F) +
  theme_bw() +
  theme(axis.ticks.x = element_blank(),axis.text.x = element_blank())

# Plotting left lung psill fev1/fvc model no race.
pl_fev1_fvc_no_race_pred_df <- expand.grid(BMI = bmi_mean,Age = age_mean,
                                        Height = height_mean, 
                                        Gender = gender_select,
                                        slice_normalized = slice_normalized_vec,
                                        POSTFEVFVC = fev1fvc_quantiles,ID = ID_pred)

pl_fev1_fvc_no_race_pred <- predict(gam_models$left_psill_postfev1fvc_no_race_mod,
                                 newdata = pl_fev1_fvc_no_race_pred_df,
                                 type = "response", exclude = "s(ID)",
                                 se.fit = TRUE)

pl_fev1_fvc_no_race_df <- data.frame(pl_fev1_fvc_no_race_pred_df,
                                  "Yhat" = pl_fev1_fvc_no_race_pred$fit,
                                  "LB" = pl_fev1_fvc_no_race_pred$fit -
                                    qnorm(0.975)*pl_fev1_fvc_no_race_pred$se.fit,
                                  "UB" = pl_fev1_fvc_no_race_pred$fit +
                                    qnorm(0.975)*pl_fev1_fvc_no_race_pred$se.fit)

pl_fev1_fvc_no_race_plot <- ggplot(pl_fev1_fvc_no_race_df, 
                                aes(x = slice_normalized,
                                    y = Yhat,
                                    color = factor(POSTFEVFVC))) +
  geom_line() +
  geom_ribbon(aes(ymin = LB,ymax = UB,fill = factor(POSTFEVFVC)),alpha = 0.1,
              linetype = "dotted") +
  labs(y = "Predicted log(Psill)",x = "",
       title = "Left Psill FEV1/FVC - No Race") +
  scale_fill_discrete(name = "Quantiles",labels = c("0.25","0.50","0.75")) +
  guides(color = F) +
  theme_bw() +
  theme(axis.ticks.x = element_blank(),axis.text.x = element_blank())

# Plotting right lung psill fev1/fvc model no race.
pr_fev1_fvc_no_race_pred_df <- expand.grid(BMI = bmi_mean,Age = age_mean,
                                        Height = height_mean, 
                                        Gender = gender_select,
                                        slice_normalized = slice_normalized_vec,
                                        POSTFEVFVC = fev1fvc_quantiles,ID = ID_pred)

pr_fev1_fvc_no_race_pred <- predict(gam_models$right_psill_postfev1fvc_no_race_mod,
                                 newdata = pr_fev1_fvc_no_race_pred_df,
                                 type = "response", exclude = "s(ID)",
                                 se.fit = TRUE)

pr_fev1_fvc_no_race_df <- data.frame(pr_fev1_fvc_no_race_pred_df,
                                  "Yhat" = pr_fev1_fvc_no_race_pred$fit,
                                  "LB" = pr_fev1_fvc_no_race_pred$fit -
                                    qnorm(0.975)*pr_fev1_fvc_no_race_pred$se.fit,
                                  "UB" = pr_fev1_fvc_no_race_pred$fit +
                                    qnorm(0.975)*pr_fev1_fvc_no_race_pred$se.fit)

pr_fev1_fvc_no_race_plot <- ggplot(pr_fev1_fvc_no_race_df, 
                                aes(x = slice_normalized,
                                    y = Yhat,
                                    color = factor(POSTFEVFVC))) +
  geom_line() +
  geom_ribbon(aes(ymin = LB,ymax = UB,fill = factor(POSTFEVFVC)),alpha = 0.1,
              linetype = "dotted") +
  labs(y = "Predicted log(Psill)",x = "",
       title = "Right Psill FEV1/FVC - No Race") +
  scale_fill_discrete(name = "Quantiles",labels = c("0.25","0.50","0.75")) +
  guides(color = F) +
  theme_bw() +
  theme(axis.ticks.x = element_blank(),axis.text.x = element_blank())

# Plotting left lung range fev1/fvc model with race.
rl_fev1_fvc_race_pred_df <- expand.grid(BMI = bmi_mean,Age = age_mean,
                                        Height = height_mean, 
                                        Gender = gender_select,
                                        Race = race_select,
                                        slice_normalized = slice_normalized_vec,
                                        POSTFEVFVC = fev1fvc_quantiles,ID = ID_pred)

rl_fev1_fvc_race_pred <- predict(gam_models$left_range_postfev1fvc_race_mod,
                                 newdata = rl_fev1_fvc_race_pred_df,
                                 type = "response", exclude = "s(ID)",
                                 se.fit = TRUE)

rl_fev1_fvc_race_df <- data.frame(rl_fev1_fvc_race_pred_df,
                                  "Yhat" = rl_fev1_fvc_race_pred$fit,
                                  "LB" = rl_fev1_fvc_race_pred$fit -
                                    qnorm(0.975)*rl_fev1_fvc_race_pred$se.fit,
                                  "UB" = rl_fev1_fvc_race_pred$fit +
                                    qnorm(0.975)*rl_fev1_fvc_race_pred$se.fit)

rl_fev1_fvc_race_plot <- ggplot(rl_fev1_fvc_race_df, 
                                aes(x = slice_normalized,
                                    y = Yhat,
                                    color = factor(POSTFEVFVC))) +
  geom_line() +
  geom_ribbon(aes(ymin = LB,ymax = UB,fill = factor(POSTFEVFVC)),alpha = 0.1,
              linetype = "dotted") +
  labs(y = "Predicted log(Range)",x = "",
       title = "Left Range FEV1/FVC - With Race") +
  scale_fill_discrete(name = "Quantiles",labels = c("0.25","0.50","0.75")) +
  guides(color = F) +
  theme_bw() +
  theme(axis.ticks.x = element_blank(),axis.text.x = element_blank())

# Plotting right lung range fev1/fvc model with race.
rr_fev1_fvc_race_pred_df <- expand.grid(BMI = bmi_mean,Age = age_mean,
                                        Height = height_mean, 
                                        Gender = gender_select,
                                        Race = race_select,
                                        slice_normalized = slice_normalized_vec,
                                        POSTFEVFVC = fev1fvc_quantiles,ID = ID_pred)

rr_fev1_fvc_race_pred <- predict(gam_models$right_range_postfev1fvc_race_mod,
                                 newdata = rr_fev1_fvc_race_pred_df,
                                 type = "response", exclude = "s(ID)",
                                 se.fit = TRUE)

rr_fev1_fvc_race_df <- data.frame(rr_fev1_fvc_race_pred_df,
                                  "Yhat" = rr_fev1_fvc_race_pred$fit,
                                  "LB" = rr_fev1_fvc_race_pred$fit -
                                    qnorm(0.975)*rr_fev1_fvc_race_pred$se.fit,
                                  "UB" = rr_fev1_fvc_race_pred$fit +
                                    qnorm(0.975)*rr_fev1_fvc_race_pred$se.fit)

rr_fev1_fvc_race_plot <- ggplot(rr_fev1_fvc_race_df, 
                                aes(x = slice_normalized,
                                    y = Yhat,
                                    color = factor(POSTFEVFVC))) +
  geom_line() +
  geom_ribbon(aes(ymin = LB,ymax = UB,fill = factor(POSTFEVFVC)),alpha = 0.1,
              linetype = "dotted") +
  labs(y = "Predicted log(Range)",x = "",
       title = "Right Range FEV1/FVC - With Race") +
  scale_fill_discrete(name = "Quantiles",labels = c("0.25","0.50","0.75")) +
  guides(color = F) +
  theme_bw() +
  theme(axis.ticks.x = element_blank(),axis.text.x = element_blank())

# Plotting left lung range fev1/fvc model no race.
rl_fev1_fvc_no_race_pred_df <- expand.grid(BMI = bmi_mean,Age = age_mean,
                                        Height = height_mean, 
                                        Gender = gender_select,
                                        Race = race_select,
                                        slice_normalized = slice_normalized_vec,
                                        POSTFEVFVC = fev1fvc_quantiles,ID = ID_pred)

rl_fev1_fvc_no_race_pred <- predict(gam_models$left_range_postfev1fvc_no_race_mod,
                                 newdata = rl_fev1_fvc_no_race_pred_df,
                                 type = "response", exclude = "s(ID)",
                                 se.fit = TRUE)

rl_fev1_fvc_no_race_df <- data.frame(rl_fev1_fvc_no_race_pred_df,
                                  "Yhat" = rl_fev1_fvc_no_race_pred$fit,
                                  "LB" = rl_fev1_fvc_no_race_pred$fit -
                                    qnorm(0.975)*rl_fev1_fvc_no_race_pred$se.fit,
                                  "UB" = rl_fev1_fvc_no_race_pred$fit +
                                    qnorm(0.975)*rl_fev1_fvc_no_race_pred$se.fit)

rl_fev1_fvc_no_race_plot <- ggplot(rl_fev1_fvc_no_race_df, 
                                aes(x = slice_normalized,
                                    y = Yhat,
                                    color = factor(POSTFEVFVC))) +
  geom_line() +
  geom_ribbon(aes(ymin = LB,ymax = UB,fill = factor(POSTFEVFVC)),alpha = 0.1,
              linetype = "dotted") +
  labs(y = "Predicted log(Range)",x = "Normalized Slice",
       title = "Left Range FEV1/FVC - No Race") +
  scale_fill_discrete(name = "Quantiles",labels = c("0.25","0.50","0.75")) +
  guides(color = F) +
  theme_bw() 

# Plotting right lung range fev1/fvc model no race.
rr_fev1_fvc_no_race_pred_df <- expand.grid(BMI = bmi_mean,Age = age_mean,
                                        Height = height_mean, 
                                        Gender = gender_select,
                                        Race = race_select,
                                        slice_normalized = slice_normalized_vec,
                                        POSTFEVFVC = fev1fvc_quantiles,ID = ID_pred)

rr_fev1_fvc_no_race_pred <- predict(gam_models$right_range_postfev1fvc_no_race_mod,
                                 newdata = rr_fev1_fvc_no_race_pred_df,
                                 type = "response", exclude = "s(ID)",
                                 se.fit = TRUE)

rr_fev1_fvc_no_race_df <- data.frame(rr_fev1_fvc_no_race_pred_df,
                                  "Yhat" = rr_fev1_fvc_no_race_pred$fit,
                                  "LB" = rr_fev1_fvc_no_race_pred$fit -
                                    qnorm(0.975)*rr_fev1_fvc_no_race_pred$se.fit,
                                  "UB" = rr_fev1_fvc_no_race_pred$fit +
                                    qnorm(0.975)*rr_fev1_fvc_no_race_pred$se.fit)

rr_fev1_fvc_no_race_plot <- ggplot(rr_fev1_fvc_no_race_df, 
                                aes(x = slice_normalized,
                                    y = Yhat,
                                    color = factor(POSTFEVFVC))) +
  geom_line() +
  geom_ribbon(aes(ymin = LB,ymax = UB,fill = factor(POSTFEVFVC)),alpha = 0.1,
              linetype = "dotted") +
  labs(y = "Predicted log(Range)",x = "Normalized Slice",
       title = "Right Range FEV1/FVC - No Race") +
  scale_fill_discrete(name = "Quantiles",labels = c("0.25","0.50","0.75")) +
  guides(color = F) +
  theme_bw()

```

```{r fev1_fvc_plot_print, echo = F, fig.height = 8}

# Formatting plots for FEV1/FVC. 
(pl_fev1_fvc_race_plot + pr_fev1_fvc_race_plot)/(pl_fev1_fvc_no_race_plot + pr_fev1_fvc_no_race_plot)/
  (rl_fev1_fvc_race_plot + rr_fev1_fvc_race_plot)/(rl_fev1_fvc_no_race_plot + rr_fev1_fvc_no_race_plot)

```
\doublespacing
The plots above show the trend of range and psill when moving up the lung (normalized slice) when FEV1/FVC is the main clinical predictor. Models including race have slightly wider confidence intervals, but trends in both sets of plots including and excluding race are similar. Subsequent analysis will only consider models excluding race. For both psill and range there is significant overlap before the middle portion of the lung. When moving towards the middle portion of the lung there is a slight spread of lines, with higher FEV1/FVC values corresponding to lower psill and range values. As the scans move further up the lung the expected range and psill move closer together. 

\singlespacing

# Discussion

### Race as a Predictor
\doublespacing
Direct model comparison using AIC suggested that there were minimal differences between models including race and models excluding race. For example, the left lung psill model including race had an AIC of -470.2398, while the model excluding race had a psill of -470.0661, meaning that the model including race had an AIC only 0.1737 units lower than the model excluding race. Between all models only the psill models where fibrosis, mediastinal lymphadenopathy, traction bronchiectasis, and FEV1/FVC were the clinical predictors had AIC values which were slightly lower for models including race compared to models which excluded race. Psill models where FEV1 and FVC were the clinical predictors and all models for range had lower AIC values for models which excluded race. Again, the differences were all below 1. In deciding on whether to include race or not for based on AIC values models without race will have a higher proportion of lower AIC values compared to models that included race. 

Based on model outputs from the tables provided in the results neither race category of non-Hispanic white or other was a significant predictor for the range outcome when the reference group was African American/Black. For psill models the non-Hispanic white category was generally significant while the other races category was never a significant predictor. Additionally, the interaction between the clinical predictor and normalized slice was significant in all models regardless of whether or not race was included as a predictor. From the plots the relationship between models including and excluding race had the same general trend, with the main difference being that models without race tended to have slightly narrower confidence intervals. These narrower confidence intervals gave better discrepancy in predicted outcome between the binary VAS conditions and the three levels of PFT measurements (25th percentile, 50th percentile, and 75 percentile).

Beyond data analyzed in this study, past studies have noted difficulty in assessing the prevalence in sarcoidosis among different racial groups. For example, a study in the American Journal of Epidemiology noted that while African-Americans were found to have threefold higher risk of sarcoidosis compared to Caucasians, it is difficult to determine the degree that environmental exposure versus genetic susceptibility accounts for this difference [@racial_differences_sarcoidosis]. Additionally, socioeconomic status (SES) is a known predictor of health outcomes, and patients of low SES tend to have worse pulmonary function, lower baseline physical health, and higher likelihood of multi-organ disease after adjusting for comorbidities [@diversity_disparity]. In the context of this study, simply adjusting for race will likely overlook more important predictors of sarcoidosis, and obfuscate care for those who are most at risk. In another study an age-adjusted mortality rate increase of 50\% between 1988 and 2007 in the United States was observed for Caucasians and not African Americans, with the authors suggesting that access to more advanced medical technology by Caucasian patients could explain higher rates of detection and bias in diagnoses [@sarcoidosis_mortality]. As more advanced imaging options become available past assumptions regarding sarcoidosis susceptibility need careful scrutiny to avoid perpetuating bias in treatment and diagnosis.  

### Relationship Between Clinical Predictors and Outcomes



\singlespacing
# References

<div id="refs"></div>


